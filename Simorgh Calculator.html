<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ú©Ø§Ù†Ú©Ø³ - Ø´Ø±Ú©Øª Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>
    <!-- Persian Font (Vazirmatn) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
            color: #334155; /* Slate-700 */
            padding-bottom: 80px; /* Space for potential mobile nav */
        }

        /* --- INPUTS & FORMS --- */
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 700;
            color: #0f766e; /* Teal-700 */
            margin-bottom: 0.5rem;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            background-color: white;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #14b8a6; /* Teal-500 */
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
        }
        
        /* Number inputs styling */
        input[type="number"], .price-input {
            direction: ltr;
            text-align: left;
            font-family: monospace;
            font-weight: 700;
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:active {
            transform: scale(0.96);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #115e59 0%, #0f766e 100%);
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3);
        }

        .btn-danger {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }
        .btn-danger:hover {
            background-color: #fecaca;
            color: #b91c1c;
        }

        .btn-warning {
            background-color: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        .btn-warning:hover {
            background-color: #fde68a;
        }

        /* --- CARDS & CONTAINERS --- */
        .card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #0d9488; /* Teal border top */
            margin-bottom: 1.5rem;
        }

        /* --- TABS --- */
        .tab-container {
            display: flex;
            background: white;
            padding: 0.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            text-align: center;
            border-radius: 0.75rem;
            font-weight: 700;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab-btn.active {
            background-color: #ccfbf1; /* Teal-100 */
            color: #0f766e; /* Teal-800 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- UPDATED DATE BADGE --- */
        .update-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            background-color: #fff1f2; /* Rose-50 */
            color: #be123c; /* Rose-700 */
            border: 1px solid #fda4af;
            font-weight: bold;
            white-space: nowrap;
        }
        .update-badge svg {
            width: 12px;
            height: 12px;
            margin-left: 4px;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            .no-print { display: none !important; }
        }

        /* --- ANIMATIONS --- */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- LOADING OVERLAY (Initial) -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center text-white">
        <div class="loader"></div>
        <p class="mt-4 font-bold text-lg">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...</p>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto hidden fade-in">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="text-center md:text-right">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-1">
                    Ø´Ø±Ú©Øª <span class="text-teal-600">Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</span>
                </h1>
                <p class="text-slate-500 font-medium">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ú©Ø§Ù†Ú©Ø³</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg border border-green-100">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-sm text-green-700 font-bold">Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª</span>
            </div>
        </header>

        <!-- TABS -->
        <div class="tab-container">
            <button onclick="switchTab('formulas')" class="tab-btn active" id="btn-formulas">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§</button>
            <button onclick="switchTab('materials')" class="tab-btn" id="btn-materials">ğŸ“¦ Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</button>
            <button onclick="switchTab('categories')" class="tab-btn" id="btn-categories">ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
        </div>

        <!-- =========================================
             TAB 1: CATEGORIES (Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§)
             ========================================= -->
        <div id="tab-categories" class="hidden">
            <div class="card max-w-xl mx-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="w-1 h-6 bg-teal-500 rounded ml-2"></span>
                    Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
                </h2>
                <p class="text-sm text-slate-500 mb-4">Ø¨Ø±Ø§ÛŒ Ù†Ø¸Ù… Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ø¢Ù‡Ù†â€ŒØ¢Ù„Ø§ØªØŒ Ú†ÙˆØ¨ØŒ Ø¨Ø±Ù‚...).</p>
                
                <form onsubmit="handleAddCategory(event)" class="flex gap-2 mb-6">
                    <input type="text" id="cat-name" class="input-field" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯..." required>
                    <button type="submit" class="btn btn-primary px-6">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </form>

                <div id="category-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    <!-- Categories render here -->
                </div>
            </div>
        </div>

        <!-- =========================================
             TAB 2: MATERIALS (Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡)
             ========================================= -->
        <div id="tab-materials" class="hidden">
            <!-- Add Material Form -->
            <div class="card">
                <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                    <span class="w-1 h-6 bg-teal-500 rounded ml-2"></span>
                    Ø§ÙØ²ÙˆØ¯Ù† / ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§
                </h2>
                <form onsubmit="handleSaveMaterial(event)" id="material-form">
                    <input type="hidden" id="mat-id">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                            <select id="mat-category" class="input-field">
                                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-1">
                            <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù„Ø§</label>
                            <input type="text" id="mat-name" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ù¾Ø±ÙˆÙÛŒÙ„ Û´Û°*Û´Û°" required>
                        </div>
                        <div>
                            <label class="form-label">ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ø´</label>
                            <input type="text" id="mat-unit" class="input-field" placeholder="Ø´Ø§Ø®Ù‡ØŒ Ú©ÛŒÙ„ÙˆØŒ Ù…ØªØ±..." required>
                        </div>
                        <div>
                            <label class="form-label">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="text" id="mat-price" class="input-field price-input" placeholder="0" oninput="formatInput(this)" required>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="btn btn-primary flex-1" id="mat-submit-btn">Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù„Ø§ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±</button>
                        <button type="button" onclick="resetMaterialForm()" class="btn btn-danger hidden" id="mat-cancel-btn">Ù„ØºÙˆ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    </div>
                </form>
            </div>

            <!-- Materials List -->
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-bold text-slate-700">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù†Ø¨Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</h3>
                    <div class="relative w-full sm:w-72">
                        <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù†Ø§Ù… Ú©Ø§Ù„Ø§..." oninput="renderMaterials(this.value)" class="input-field pl-10">
                        <span class="absolute left-3 top-3 text-slate-400">ğŸ”</span>
                    </div>
                </div>
                
                <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Materials render here -->
                </div>
            </div>
        </div>

        <!-- =========================================
             TAB 3: FORMULAS (ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§)
             ========================================= -->
        <div id="tab-formulas">
            <!-- Create Formula -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-slate-800 mb-4">ØªØ¹Ø±ÛŒÙ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯ (ÙØ±Ù…ÙˆÙ„)</h2>
                <form onsubmit="handleCreateFormula(event)" class="flex gap-3">
                    <input type="text" id="new-formula-name" class="input-field" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù†Ù‡Ø§ÛŒÛŒ (Ù…Ø«Ù„Ø§Ù‹: Ú©Ø§Ù†Ú©Ø³ Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ Û²*Û² Ø¨Ø§ Ø¹Ø§ÛŒÙ‚ Ù¾Ø´Ù… Ø³Ù†Ú¯)" required>
                    <button type="submit" class="btn btn-primary px-8 whitespace-nowrap">Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù…ÙˆÙ„</button>
                </form>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                <!-- Master List (Sidebar) -->
                <div class="lg:col-span-4 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden h-[600px] flex flex-col">
                    <div class="p-4 bg-slate-50 border-b">
                        <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§..." oninput="renderFormulaList(this.value)" class="input-field text-sm">
                    </div>
                    <div id="formula-master-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- Formula List Items -->
                    </div>
                </div>

                <!-- Detail View (Main) -->
                <div class="lg:col-span-8">
                    <div id="formula-detail-empty" class="bg-white rounded-2xl shadow-lg p-16 text-center border-2 border-dashed border-slate-300">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <p class="text-xl font-bold text-slate-600">Ù‡Ù†ÙˆØ² ÙØ±Ù…ÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p class="text-slate-400 mt-2">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯.</p>
                    </div>

                    <div id="formula-detail-view" class="hidden space-y-6">
                        <!-- Detail Card injected by JS -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- =========================================
         PRINT MODAL (Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±)
         ========================================= -->
    <div id="print-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('print-modal')">
        <div class="modal-box" id="print-section">
            <!-- Print Header -->
            <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-6">
                <div class="text-right">
                    <h2 class="text-2xl font-black text-slate-800">Ø´Ø±Ú©Øª Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</h2>
                    <p class="text-slate-600 mt-1 text-sm">ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ù†Ú©Ø³ Ùˆ Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡</p>
                </div>
                <div class="text-left">
                    <h1 class="text-3xl font-black text-teal-700">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h1>
                    <p class="text-slate-500 mt-1" id="print-date">ØªØ§Ø±ÛŒØ®: --/--/--</p>
                </div>
            </div>
            
            <div class="mb-8 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-2">Ù…Ø´Ø®ØµØ§Øª Ù…Ø­ØµÙˆÙ„:</h3>
                <p class="text-xl font-bold text-slate-900" id="print-title">---</p>
            </div>

            <!-- Table -->
            <table class="w-full mb-8 border-collapse">
                <thead>
                    <tr class="bg-slate-800 text-white">
                        <th class="text-right p-3 rounded-r-lg">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Ø§Øª</th>
                        <th class="text-center p-3 w-24">Ù…Ù‚Ø¯Ø§Ø±</th>
                        <th class="text-center p-3 w-24 rounded-l-lg">ÙˆØ§Ø­Ø¯</th>
                    </tr>
                </thead>
                <tbody id="print-rows" class="text-sm">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>

            <!-- Totals -->
            <div class="flex justify-end">
                <div class="w-full md:w-1/2 bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <div class="flex justify-between mb-3 text-slate-600">
                        <span>Ø¬Ù…Ø¹ Ú©Ù„ Ù…ÙˆØ§Ø¯ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</span>
                        <span class="font-mono font-bold text-slate-800" id="print-total">0</span>
                    </div>
                    <div class="flex justify-between mb-4 text-slate-500 text-sm pb-4 border-b border-slate-300">
                        <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (Û±Û°Ùª):</span>
                        <span class="font-mono" id="print-tax">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-slate-900">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span class="text-2xl font-black text-teal-700" id="print-final">0 <span class="text-sm font-normal text-slate-500">ØªÙˆÙ…Ø§Ù†</span></span>
                    </div>
                </div>
            </div>

            <!-- Print Footer (No Print) -->
            <div class="mt-8 text-center no-print border-t pt-6">
                <button onclick="window.print()" class="btn btn-primary px-8 py-3 text-lg shadow-lg gap-2">
                    Ú†Ø§Ù¾ / Ø°Ø®ÛŒØ±Ù‡ PDF
                </button>
                <button onclick="closeModal('print-modal')" class="btn btn-danger px-6 py-3 mr-2">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // 1. CONFIGURATION & SETUP
        // ------------------------------------------------------------------
        const APPWRITE_CONFIG = {
            ENDPOINT: 'https://cloud.appwrite.io/v1',
            PROJECT_ID: '691c9337000c1532f26a',  // <--- Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
            DB_ID: '691c956400150133e319',      // <--- Ø´Ù†Ø§Ø³Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
            COLS: {
                CATS: 'categories',
                MATS: 'materials',
                FORMS: 'formulas'
            }
        };

        const { Client, Account, Databases, ID, Query } = Appwrite;
        const client = new Client().setEndpoint(APPWRITE_CONFIG.ENDPOINT).setProject(APPWRITE_CONFIG.PROJECT_ID);
        const account = new Account(client);
        const db = new Databases(client);

        // Global State
        let state = {
            categories: [],
            materials: [],
            formulas: [],
            activeFormulaId: null
        };

        // ------------------------------------------------------------------
        // 2. INITIALIZATION (No Login Screen)
        // ------------------------------------------------------------------
        async function init() {
            try {
                // Try to get session, if fails, create anonymous
                try {
                    await account.get();
                } catch (e) {
                    console.log("No session, creating anonymous...");
                    await account.createAnonymousSession();
                }
                
                // Load data
                await loadAllData();
                
                // Show App
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
            } catch (err) {
                console.error("Init Error:", err);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Appwrite Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.");
            }
        }

        // ------------------------------------------------------------------
        // 3. DATA LOADING
        // ------------------------------------------------------------------
        async function loadAllData() {
            // Fetch everything in parallel for speed
            const [cRes, mRes, fRes] = await Promise.all([
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, [Query.limit(100)]),
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, [Query.limit(5000)]), // High limit for materials
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, [Query.limit(500)])
            ]);

            state.categories = cRes.documents;
            state.materials = mRes.documents.sort((a, b) => a.name.localeCompare(b.name));
            state.formulas = fRes.documents.sort((a, b) => new Date(b.$updatedAt) - new Date(a.$updatedAt)); // Sort by newest

            updateUI();
        }

        function updateUI() {
            renderCategories();
            renderMaterials();
            updateDropdowns();
            renderFormulaList();
            if (state.activeFormulaId) renderFormulaDetail(state.activeFormulaId);
        }

        // Format Date Helper (Fa-IR)
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return new Intl.DateTimeFormat('fa-IR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }).format(date);
        }

        // Format Price Helper
        function formatPrice(num) {
            return num.toLocaleString('en-US');
        }

        // ------------------------------------------------------------------
        // 4. CATEGORIES LOGIC
        // ------------------------------------------------------------------
        async function handleAddCategory(e) {
            e.preventDefault();
            const nameInput = document.getElementById('cat-name');
            const name = nameInput.value.trim();
            
            if (state.categories.some(c => c.name === name)) return alert('Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.');

            try {
                const res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, ID.unique(), { name });
                state.categories.push(res);
                updateUI();
                nameInput.value = '';
            } catch (err) { console.error(err); }
        }

        async function deleteCategory(id) {
            if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø§ Ø­Ø°Ù Ø¯Ø³ØªÙ‡ØŒ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.')) return;
            try {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, id);
                state.categories = state.categories.filter(c => c.$id !== id);
                updateUI();
            } catch(err) { console.error(err); }
        }

        function renderCategories() {
            document.getElementById('category-list').innerHTML = state.categories.map(c => `
                <div class="flex justify-between bg-slate-50 p-3 rounded-lg border border-slate-200 items-center hover:bg-white transition-colors">
                    <span class="font-bold text-slate-700">${c.name}</span>
                    <button onclick="deleteCategory('${c.$id}')" class="text-rose-500 hover:bg-rose-100 p-2 rounded-full transition-colors">ğŸ—‘</button>
                </div>
            `).join('');
        }

        // ------------------------------------------------------------------
        // 5. MATERIALS LOGIC
        // ------------------------------------------------------------------
        async function handleSaveMaterial(e) {
            e.preventDefault();
            const id = document.getElementById('mat-id').value;
            const name = document.getElementById('mat-name').value.trim();
            const unit = document.getElementById('mat-unit').value;
            const price = parseFloat(document.getElementById('mat-price').value.replace(/,/g, ''));
            const category_id = document.getElementById('mat-category').value || null;

            if (!id && state.materials.some(m => m.name === name)) return alert('Ù†Ø§Ù… Ú©Ø§Ù„Ø§ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª!');

            try {
                const data = { name, unit, price, category_id };
                let res;
                if (id) {
                    res = await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, id, data);
                    const idx = state.materials.findIndex(m => m.$id === id);
                    state.materials[idx] = res;
                } else {
                    res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, ID.unique(), data);
                    state.materials.push(res);
                }
                // Sort A-Z
                state.materials.sort((a, b) => a.name.localeCompare(b.name));
                updateUI();
                resetMaterialForm();
            } catch (err) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + err.message); }
        }

        function editMaterial(id) {
            const m = state.materials.find(x => x.$id === id);
            if(!m) return;
            document.getElementById('mat-id').value = m.$id;
            document.getElementById('mat-name').value = m.name;
            document.getElementById('mat-unit').value = m.unit;
            document.getElementById('mat-price').value = formatPrice(m.price);
            document.getElementById('mat-category').value = m.category_id || "";
            
            document.getElementById('mat-submit-btn').textContent = "Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù„Ø§";
            document.getElementById('mat-submit-btn').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('mat-cancel-btn').classList.remove('hidden');
            
            document.getElementById('tab-materials').scrollIntoView({behavior: 'smooth'});
        }

        async function deleteMaterial(id) {
            if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
            try {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, id);
                state.materials = state.materials.filter(m => m.$id !== id);
                updateUI();
            } catch(err) { console.error(err); }
        }

        function resetMaterialForm() {
            document.getElementById('material-form').reset();
            document.getElementById('mat-id').value = '';
            document.getElementById('mat-submit-btn').textContent = "Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù„Ø§ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±";
            document.getElementById('mat-submit-btn').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('mat-cancel-btn').classList.add('hidden');
        }

        function renderMaterials(filter = '') {
            const container = document.getElementById('materials-container');
            const filtered = state.materials.filter(m => m.name.includes(filter));
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-slate-400 py-8">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            container.innerHTML = filtered.map(m => {
                const cat = state.categories.find(c => c.$id === m.category_id)?.name || 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡';
                return `
                <div class="bg-white p-5 rounded-2xl border border-slate-200 hover:shadow-lg transition-all relative group border-b-4 border-b-teal-500">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-slate-100 text-slate-600 text-[11px] px-2 py-1 rounded-md font-bold">${cat}</span>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                            <button onclick="editMaterial('${m.$id}')" class="text-amber-500 hover:text-amber-600" title="ÙˆÛŒØ±Ø§ÛŒØ´">âœ</button>
                            <button onclick="deleteMaterial('${m.$id}')" class="text-rose-500 hover:text-rose-600" title="Ø­Ø°Ù">âœ•</button>
                        </div>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-1">${m.name}</h3>
                    
                    <div class="mt-4 pt-3 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-400">ÙˆØ§Ø­Ø¯: ${m.unit}</span>
                            <span class="font-black text-teal-700 font-mono text-lg">${formatPrice(m.price)}</span>
                        </div>
                        
                        <!-- DATE BADGE (High Visibility) -->
                        <div class="flex items-center justify-end">
                             <div class="update-badge">
                                <span>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${formatDate(m.$updatedAt)}</span>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function updateDropdowns() {
            let options = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';
            
            state.categories.forEach(cat => {
                const items = state.materials.filter(m => m.category_id === cat.$id);
                if(items.length) {
                    options += `<optgroup label="${cat.name}">`;
                    items.forEach(m => options += `<option value="${m.$id}">${m.name}</option>`);
                    options += `</optgroup>`;
                }
            });
            
            const noCat = state.materials.filter(m => !m.category_id);
            if(noCat.length) {
                options += `<optgroup label="Ø³Ø§ÛŒØ±">`;
                noCat.forEach(m => options += `<option value="${m.$id}">${m.name}</option>`);
                options += `</optgroup>`;
            }

            // Update material form dropdown
            const matCatSelect = document.getElementById('mat-category');
            if(matCatSelect) {
                matCatSelect.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡ --</option>' + 
                state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('');
            }
            
            // Update formula component dropdown
            const compSelect = document.getElementById('comp-select');
            if(compSelect) compSelect.innerHTML = options;
        }

        // ------------------------------------------------------------------
        // 6. FORMULAS LOGIC
        // ------------------------------------------------------------------
        async function handleCreateFormula(e) {
            e.preventDefault();
            const name = document.getElementById('new-formula-name').value;
            try {
                const res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, ID.unique(), {
                    name, 
                    components: JSON.stringify([]), 
                    labor: 0.0, overhead: 0.0, profit: 0.0
                });
                state.formulas.unshift(res); // Add to top
                document.getElementById('new-formula-name').value = '';
                selectFormula(res.$id);
            } catch(err) { console.error(err); }
        }

        function selectFormula(id) {
            state.activeFormulaId = id;
            renderFormulaList();
            document.getElementById('formula-detail-empty').classList.add('hidden');
            document.getElementById('formula-detail-view').classList.remove('hidden');
            renderFormulaDetail(id);
        }

        async function deleteFormula(id) {
            if(!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙØ±Ù…ÙˆÙ„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
            try {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, id);
                state.formulas = state.formulas.filter(f => f.$id !== id);
                if(state.activeFormulaId === id) {
                    state.activeFormulaId = null;
                    document.getElementById('formula-detail-view').classList.add('hidden');
                    document.getElementById('formula-detail-empty').classList.remove('hidden');
                }
                renderFormulaList();
            } catch(err) { console.error(err); }
        }

        function renderFormulaList(filter = '') {
            const list = document.getElementById('formula-master-list');
            const filtered = state.formulas.filter(f => f.name.includes(filter));
            
            list.innerHTML = filtered.map(f => `
                <div onclick="selectFormula('${f.$id}')" class="p-4 border-b border-slate-100 cursor-pointer hover:bg-teal-50 transition-all flex justify-between items-center ${f.$id === state.activeFormulaId ? 'bg-teal-50 border-r-4 border-teal-600' : ''}">
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-700 text-sm">${f.name}</span>
                        <span class="text-[10px] text-slate-400 mt-1">Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±: ${formatDate(f.$updatedAt)}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteFormula('${f.$id}')" class="text-slate-300 hover:text-rose-500 p-1">âœ–</button>
                </div>
            `).join('');
        }

        // --- CORE COST CALCULATION ---
        function calculateCost(formulaId, stack = []) {
            if(stack.includes(formulaId)) return { cost: 0, error: true }; // Loop protection
            
            const f = state.formulas.find(x => x.$id === formulaId);
            if(!f) return { cost: 0 };

            let matCost = 0;
            const components = JSON.parse(f.components || '[]');

            components.forEach(comp => {
                if(comp.type === 'mat') {
                    const m = state.materials.find(x => x.$id === comp.id);
                    if(m) matCost += m.price * comp.qty;
                } else if (comp.type === 'form') {
                    const sub = calculateCost(comp.id, [...stack, formulaId]);
                    matCost += sub.final * comp.qty; // Use final price of sub-formula
                }
            });

            const labor = f.labor || 0;
            const overhead = f.overhead || 0;
            const sub = matCost + labor + overhead;
            const profit = (f.profit || 0) / 100 * sub;
            return {
                matCost, labor, overhead, sub, profit,
                final: sub + profit
            };
        }

        function renderFormulaDetail(id) {
            const f = state.formulas.find(x => x.$id === id);
            if(!f) return;
            
            const calc = calculateCost(id);
            const components = JSON.parse(f.components || '[]');

            const rows = components.map((c, idx) => {
                let name = '?', unit = '-', price = 0, total = 0, lastUpdate = '';
                
                if(c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if(m) { 
                        name = m.name; unit = m.unit; price = m.price; total = price * c.qty; 
                        lastUpdate = m.$updatedAt;
                    }
                    else name = '<span class="text-red-500 italic">Ú©Ø§Ù„Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡</span>';
                } else {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    if(sub) { 
                        name = `<span class="text-blue-600 font-bold flex items-center gap-1"><span class="text-xs">ğŸ”—</span> ${sub.name}</span>`; 
                        unit = 'Ø¹Ø¯Ø¯'; 
                        const subCalc = calculateCost(c.id, [id]);
                        price = subCalc.final;
                        total = price * c.qty;
                        lastUpdate = sub.$updatedAt;
                    }
                }

                return `
                    <div class="flex justify-between items-center p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                        <div class="flex-grow">
                            <div class="font-bold text-slate-700 text-sm">${name}</div>
                            <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-2 items-center">
                                <span class="font-mono">${c.qty} ${unit} Ã— ${formatPrice(price)}</span>
                                ${lastUpdate ? `<span class="bg-red-50 text-red-600 px-1.5 py-0.5 rounded text-[10px] border border-red-100">Ù‚ÛŒÙ…Øª: ${formatDate(lastUpdate)}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-600 text-sm">${formatPrice(total)}</span>
                            <button onclick="removeComponent('${id}', ${idx})" class="text-slate-300 hover:text-rose-500 font-bold px-2 transition-colors">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');

            const view = document.getElementById('formula-detail-view');
            view.innerHTML = `
                <!-- Header Card -->
                <div class="card !mb-0 border-teal-500">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                         <div>
                            <h2 class="text-2xl font-black text-slate-800 leading-tight">${f.name}</h2>
                            <span class="text-xs text-slate-400 mt-1 block">Ø´Ù†Ø§Ø³Ù‡ Ø³ÛŒØ³ØªÙ…ÛŒ: ${f.$id}</span>
                         </div>
                         <div class="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
                            <span class="text-slate-500 text-xs">Ø¢Ø®Ø±ÛŒÙ† ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ±Ù…ÙˆÙ„:</span>
                            <span class="font-bold text-slate-700 text-sm font-mono" dir="ltr">${formatDate(f.$updatedAt)}</span>
                         </div>
                    </div>
                    
                    <!-- Add Component Box -->
                    <form onsubmit="addComponent(event, '${id}')" class="bg-slate-100 p-4 rounded-xl mb-6 flex flex-col md:flex-row gap-2 shadow-inner border border-slate-200">
                        <select id="comp-select" class="flex-grow md:w-1/2 input-field !border-0" required></select>
                        <input type="number" id="comp-qty" step="any" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="w-full md:w-24 input-field !border-0 text-center font-bold" required>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg shadow-sm hover:shadow-md">+</button>
                    </form>

                    <!-- Components List -->
                    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden mb-6 shadow-sm">
                        ${rows || '<div class="p-8 text-center text-slate-400 text-sm flex flex-col items-center gap-2"><span class="text-2xl">ğŸ“­</span>Ù„ÛŒØ³Øª Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>'}
                    </div>

                    <!-- Costs Input Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Ø¯Ø³ØªÙ…Ø²Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="text" class="input-field font-bold text-slate-700" value="${formatPrice(f.labor)}" onchange="updateFormulaCost('${id}', 'labor', this.value)">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Ø³Ø±Ø¨Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="text" class="input-field font-bold text-slate-700" value="${formatPrice(f.overhead)}" onchange="updateFormulaCost('${id}', 'overhead', this.value)">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Ø³ÙˆØ¯ (Ø¯Ø±ØµØ¯)</label>
                            <input type="number" class="input-field font-bold text-slate-700" value="${f.profit}" onchange="updateFormulaCost('${id}', 'profit', this.value)">
                        </div>
                    </div>

                    <!-- Final Calculation Card (Dark) -->
                    <div class="bg-slate-800 text-white p-6 rounded-xl shadow-xl relative overflow-hidden">
                        <!-- Decorative bar -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 to-cyan-400"></div>
                        
                        <div class="flex justify-between text-sm text-slate-400 mb-1">
                            <span>Ø¬Ù…Ø¹ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡:</span> <span class="font-mono">${formatPrice(calc.matCost)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-400 mb-4 border-b border-slate-700 pb-3">
                            <span>Ù‡Ø²ÛŒÙ†Ù‡ ØªÙˆÙ„ÛŒØ¯ (Ù…ÙˆØ§Ø¯ + Ø¯Ø³ØªÙ…Ø²Ø¯ + Ø³Ø±Ø¨Ø§Ø±):</span> <span class="font-mono">${formatPrice(calc.sub)}</span>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                             <span class="text-slate-400 text-xs mb-1 uppercase tracking-widest">Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</span>
                             <span class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-200 to-cyan-200 tracking-tight mb-2">${formatPrice(calc.final)}</span>
                             <span class="text-sm text-slate-500">ØªÙˆÙ…Ø§Ù†</span>
                             
                             <!-- Explicit Date Badge -->
                             <div class="mt-4 flex items-center gap-2 bg-red-500/20 text-red-200 px-3 py-1 rounded-full border border-red-500/30 text-xs font-bold animate-pulse">
                                <span>ğŸ•’ Ø¢Ø®Ø±ÛŒÙ† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª:</span>
                                <span class="font-mono" dir="ltr">${new Date().toLocaleTimeString('fa-IR')}</span>
                             </div>
                        </div>

                        <button onclick="showPrintModal('${id}')" class="w-full mt-6 bg-white text-slate-900 py-3 rounded-lg hover:bg-slate-100 transition-colors text-sm font-bold flex justify-center items-center gap-2 shadow-lg">
                            <span>ğŸ–¨</span> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ú†Ø§Ù¾ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±
                        </button>
                    </div>
                </div>
            `;
            
            // Populate dropdown
            let options = document.getElementById('mat-category').innerHTML; 
            const otherFormulas = state.formulas.filter(x => x.$id !== id);
            if(otherFormulas.length) {
                options += `<optgroup label="ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡)">` + 
                    otherFormulas.map(x => `<option value="FORM:${x.$id}">ğŸ”— ${x.name}</option>`).join('') + 
                    `</optgroup>`;
            }
            document.getElementById('comp-select').innerHTML = options;
        }

        // --- FORMULA DB ACTIONS ---
        async function addComponent(e, fid) {
            e.preventDefault();
            const val = document.getElementById('comp-select').value;
            const qty = parseFloat(document.getElementById('comp-qty').value);
            
            let type = 'mat', id = val;
            if(val.startsWith('FORM:')) { type = 'form'; id = val.split(':')[1]; }

            const f = state.formulas.find(x => x.$id === fid);
            const comps = JSON.parse(f.components || '[]');
            
            // Add or update qty
            const exist = comps.find(c => c.id === id && c.type === type);
            if(exist) exist.qty += qty;
            else comps.push({ id, type, qty });

            try {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { components: JSON.stringify(comps) });
                f.components = JSON.stringify(comps);
                f.$updatedAt = new Date().toISOString(); // Manually update timestamp for immediate UI feedback
                renderFormulaDetail(fid);
            } catch(err) { console.error(err); }
        }

        async function removeComponent(fid, idx) {
            const f = state.formulas.find(x => x.$id === fid);
            const comps = JSON.parse(f.components || '[]');
            comps.splice(idx, 1);
            try {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { components: JSON.stringify(comps) });
                f.components = JSON.stringify(comps);
                renderFormulaDetail(fid);
            } catch(err) { console.error(err); }
        }

        async function updateFormulaCost(fid, field, val) {
            let num = parseFloat(val.replace(/,/g, '')) || 0;
            const f = state.formulas.find(x => x.$id === fid);
            f[field] = num;
            f.$updatedAt = new Date().toISOString();
            try {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { [field]: num });
                renderFormulaDetail(fid);
                renderFormulaList(); // Update timestamp in sidebar
            } catch(err) { console.error(err); }
        }

        // ------------------------------------------------------------------
        // 7. PRINT LOGIC
        // ------------------------------------------------------------------
        window.showPrintModal = (id) => {
            const f = state.formulas.find(x => x.$id === id);
            const calc = calculateCost(id);

            document.getElementById('print-title').textContent = f.name;
            document.getElementById('print-date').textContent = `ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±: ${new Date().toLocaleDateString('fa-IR')}`;

            let rowsHtml = '';
            
            // Helper to flatten items
            const getPrintItems = (formulaId, qtyMult = 1, depth = 0) => {
                const frm = state.formulas.find(x => x.$id === formulaId);
                if(!frm) return;
                const cmps = JSON.parse(frm.components || '[]');
                
                cmps.forEach(c => {
                    if(c.type === 'mat') {
                        const m = state.materials.find(x => x.$id === c.id);
                        if(m) {
                            rowsHtml += `
                                <tr class="border-b border-slate-200 ${depth > 0 ? 'bg-slate-50 text-slate-500 text-xs' : ''}">
                                    <td class="p-3 text-right pr-${depth * 6 + 3}">${depth > 0 ? 'â†³ ' : ''}${m.name}</td>
                                    <td class="p-3 text-center" dir="ltr">${(c.qty * qtyMult).toLocaleString()}</td>
                                    <td class="p-3 text-center">${m.unit}</td>
                                </tr>
                            `;
                        }
                    } else {
                         const sub = state.formulas.find(x => x.$id === c.id);
                         if(sub) {
                             rowsHtml += `
                                <tr class="border-b border-slate-200 bg-slate-100 font-bold text-slate-700">
                                    <td class="p-3 text-right pr-${depth * 4 + 2}">ğŸ”¹ ${sub.name}</td>
                                    <td class="p-3 text-center" dir="ltr">${(c.qty * qtyMult).toLocaleString()}</td>
                                    <td class="p-3 text-center">Ø¹Ø¯Ø¯</td>
                                </tr>
                            `;
                            getPrintItems(c.id, c.qty * qtyMult, depth + 1);
                         }
                    }
                });
            };

            getPrintItems(id);
            
            document.getElementById('print-rows').innerHTML = rowsHtml;
            document.getElementById('print-total').textContent = formatPrice(calc.final);
            const tax = Math.round(calc.final * 0.10);
            document.getElementById('print-tax').textContent = formatPrice(tax);
            document.getElementById('print-final').textContent = formatPrice(calc.final + tax);

            document.getElementById('print-modal').classList.remove('hidden');
            document.getElementById('print-modal').classList.add('flex');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        };

        // ------------------------------------------------------------------
        // 8. UI UTILS
        // ------------------------------------------------------------------
        window.switchTab = (tab) => {
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                 if(!el.classList.contains('tab-btn')) el.classList.add('hidden'); 
            });
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).classList.add('active');
        };

        window.formatInput = (el) => {
            const val = el.value.replace(/[^0-9.]/g, '');
            if(val) el.value = parseFloat(val).toLocaleString();
        };

        // Start App
        init();
    </script>
</body>
</html>