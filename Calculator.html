<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* =========================================
           1. CSS Styles (Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§)
           ========================================= */
        
        /* ÙÙˆÙ†Øª Ùˆ Ø¨Ø¯Ù†Ù‡ */
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            @apply bg-slate-100 text-slate-800; 
            padding-bottom: 80px; /* ÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ ÙÙˆØªØ± Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }
        
        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø²ÛŒØ¨Ø§ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ ÙØ±Ù… */
        .form-label { @apply block text-xs font-bold text-slate-500 mb-1; }
        .input-field { 
            @apply w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white transition-all text-sm shadow-sm; 
        }
        .input-field:focus { @apply border-teal-500; }
        
        /* Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ */
        input[type="number"], .price-input { direction: ltr; text-align: left; font-family: monospace; font-weight: 700; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { 
            @apply px-4 py-2 rounded-lg font-bold transition-all active:scale-95 shadow-sm flex items-center justify-center gap-2 cursor-pointer select-none text-sm; 
        }
        .btn-primary { @apply bg-teal-600 text-white hover:bg-teal-700 shadow-teal-500/20; }
        .btn-danger { @apply bg-rose-50 text-rose-600 border border-rose-200 hover:bg-rose-100; }
        .btn-secondary { @apply bg-slate-200 text-slate-700 hover:bg-slate-300; }

        /* ØªØ¨â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ */
        .nav-tabs { 
            @apply flex justify-center gap-1 p-1 bg-white rounded-2xl shadow-sm mb-6 sticky top-2 z-30 mx-auto max-w-3xl border border-slate-200; 
        }
        .tab-btn { 
            @apply flex-1 py-2 rounded-xl text-slate-500 font-bold text-sm transition-all hover:bg-slate-50; 
        }
        .tab-btn.active { @apply bg-teal-50 text-teal-700 shadow-sm ring-1 ring-teal-100; }

        /* Ù…ÙˆØ¯Ø§Ù„ (Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§ÙˆØ±) */
        .modal-overlay { 
            @apply fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 items-center justify-center p-4 hidden; /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
        }
        .modal-overlay.flex { display: flex; } /* Ú©Ù„Ø§Ø³ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ */
        
        /* Ù†Ø´Ø§Ù†Ú¯Ø±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª */
        .badge { @apply text-[10px] px-2 py-0.5 rounded border whitespace-nowrap; }
        .badge-green { @apply bg-emerald-50 text-emerald-700 border-emerald-200; }
        .badge-orange { @apply bg-orange-50 text-orange-700 border-orange-200; }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .loader { 
            border: 3px solid #e2e8f0; border-top: 3px solid #0d9488; border-radius: 50%; 
            width: 30px; height: 30px; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø®ØµÙˆØµ Ú†Ø§Ù¾ (Print Styles) */
        @media print {
            body { background: white; padding: 0; overflow: visible; }
            body * { visibility: hidden; } /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ² */
            #print-area, #print-area * { visibility: visible; } /* Ù†Ù…Ø§ÛŒØ´ ÙÙ‚Ø· Ø¨Ø®Ø´ Ù¾Ø±ÛŒÙ†Øª */
            #print-area { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; 
                box-shadow: none; border: none; 
            }
            .no-print { display: none !important; } /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ø±ÛŒÙ†Øª */
            /* Ø§Ø¬Ø¨Ø§Ø± Ú†Ø§Ù¾ Ø±Ù†Ú¯â€ŒÙ‡Ø§ */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
</head>
<body>

    <!-- =========================================
         2. Loading Screen (ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯)
         ========================================= -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold mb-2">Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</h2>
        <p class="text-sm text-slate-400 dir-ltr font-mono" id="loading-text">Connecting to Appwrite...</p>
    </div>

    <!-- =========================================
         3. Main Content (Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ)
         ========================================= -->
    <div id="app-content" class="max-w-6xl mx-auto p-4 hidden animate-fade-in">
        
        <!-- Ù‡Ø¯Ø± Ø³Ø§ÛŒØª -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 px-2 gap-4">
            <div class="text-center md:text-right">
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">
                    Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª <span class="text-teal-600">Ø³ÛŒÙ…Ø±Øº</span>
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-xs text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100 flex items-center gap-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Ø¢Ù†Ù„Ø§ÛŒÙ†
                </div>
                <button onclick="switchTab('store')" class="btn bg-purple-50 text-purple-700 border border-purple-100 hover:bg-purple-100 py-1.5 text-xs">
                    ğŸ¦ Ø¨Ø§Ù†Ú© ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§
                </button>
            </div>
        </header>

        <!-- Ù…Ù†ÙˆÛŒ ØªØ¨â€ŒÙ‡Ø§ -->
        <nav class="nav-tabs">
            <button onclick="switchTab('formulas')" class="tab-btn active" id="btn-formulas">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØµÙˆÙ„Ø§Øª</button>
            <button onclick="switchTab('materials')" class="tab-btn" id="btn-materials">Ø§Ù†Ø¨Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</button>
            <button onclick="switchTab('categories')" class="tab-btn" id="btn-categories">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
        </nav>

        <!-- >>> TAB 1: FORMULAS (Ù…Ø­ØµÙˆÙ„Ø§Øª) <<< -->
        <div id="tab-formulas">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-220px)] min-h-[600px]">
                
                <!-- Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª (Sidebar) -->
                <div class="lg:col-span-4 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-slate-100 flex gap-2 bg-slate-50 items-center">
                        <div class="relative flex-grow">
                            <input type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„..." oninput="renderFormulaList(this.value)" class="input-field text-xs pl-8 h-10">
                            <span class="absolute left-2 top-3 text-slate-400 text-xs">ğŸ”</span>
                        </div>
                        <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† ÙÙ‚Ø· Ø§ÛŒÙ†Ø¬Ø§Ø³Øª -->
                        <button onclick="openModal('new-formula-modal')" class="bg-teal-600 text-white w-10 h-10 rounded-lg hover:bg-teal-700 flex items-center justify-center font-bold shadow-sm text-xl transition-colors" title="ØªØ¹Ø±ÛŒÙ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯">+</button>
                    </div>
                    <div id="formula-master-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                        <!-- Ù„ÛŒØ³Øª ØªÙˆØ³Ø· JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </div>
                </div>

                <!-- Ù¾Ù†Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª (Detail View) -->
                <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col relative">
                    
                    <!-- Ø­Ø§Ù„Øª Ø®Ø§Ù„ÛŒ (Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡) -->
                    <div id="formula-detail-empty" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 bg-white z-10">
                        <span class="text-6xl mb-4 grayscale opacity-20">ğŸ—ï¸</span>
                        <p class="text-lg font-bold text-slate-400">Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p class="text-sm mt-1">Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯</p>
                    </div>

                    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ ÙØ±Ù…ÙˆÙ„ -->
                    <div id="formula-detail-view" class="hidden flex-col h-full">
                        <!-- Ù‡Ø¯Ø± ÙØ±Ù…ÙˆÙ„ -->
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div class="overflow-hidden">
                                <h2 id="active-formula-name" onclick="editFormulaName()" class="text-lg font-bold text-slate-800 cursor-pointer hover:text-teal-600 truncate transition-colors border-b border-dashed border-slate-300 hover:border-teal-500 inline-block pb-0.5" title="Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯">---</h2>
                                <div class="text-[10px] text-slate-400 mt-1 font-mono" id="active-formula-date">---</div>
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                                <button onclick="printFormula()" class="btn bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 py-1.5 px-3 text-xs shadow-none">ğŸ–¨ Ú†Ø§Ù¾ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±</button>
                                <button onclick="deleteFormula()" class="btn bg-white border border-rose-200 text-rose-500 hover:bg-rose-50 py-1.5 px-3 text-xs shadow-none">ğŸ—‘ Ø­Ø°Ù</button>
                            </div>
                        </div>

                        <!-- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ§Ø¯ -->
                        <div class="p-3 border-b border-slate-100 bg-white shadow-sm z-20">
                            <form onsubmit="addComp(event)" class="flex gap-2 items-center">
                                <select id="comp-filter" onchange="updateComponentSelect()" class="input-field w-1/3 md:w-1/4 text-xs bg-slate-50">
                                    <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§...</option>
                                </select>
                                <select id="comp-select" class="input-field flex-grow text-xs" required></select>
                                <div class="relative w-20">
                                    <input type="number" id="comp-qty" step="any" placeholder="#" class="input-field text-center font-bold pl-1" required>
                                    <span class="absolute left-1 top-2 text-[10px] text-slate-400 pointer-events-none">ØªØ¹Ø¯Ø§Ø¯</span>
                                </div>
                                <button class="btn btn-primary px-3 py-2 rounded-lg shadow-md">+</button>
                            </form>
                        </div>

                        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ø¬Ø²Ø§ -->
                        <div class="flex-1 overflow-y-auto bg-slate-50/30 relative">
                            <div id="formula-comps-list" class="divide-y divide-slate-100">
                                <!-- Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ ØªÙˆØ³Ø· JS -->
                            </div>
                        </div>

                        <!-- ÙÙˆØªØ± Ù…Ø­Ø§Ø³Ø¨Ø§Øª -->
                        <div class="p-4 bg-slate-800 text-slate-200 border-t border-slate-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-[10px] text-slate-400 block mb-1 font-bold">Ø¯Ø³ØªÙ…Ø²Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                                    <input id="inp-labor" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-center text-white text-sm font-mono focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition-all" onchange="updateCost('labor', this.value)">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 block mb-1 font-bold">Ø³Ø±Ø¨Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
                                    <input id="inp-overhead" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-center text-white text-sm font-mono focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition-all" onchange="updateCost('overhead', this.value)">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 block mb-1 font-bold">Ø³ÙˆØ¯ (%)</label>
                                    <input type="number" id="inp-profit" class="w-full bg-slate-700 border border-slate-600 rounded p-1.5 text-center text-white text-sm font-mono focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition-all" onchange="updateCost('profit', this.value)">
                                </div>
                            </div>
                            <div class="flex justify-between items-end pt-3 border-t border-slate-700">
                                <div>
                                    <span class="text-xs text-slate-400 block">Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† Ù…Ø§Ù„ÛŒØ§Øª):</span>
                                    <span class="text-[10px] text-slate-500">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø±Ø® Ø±ÙˆØ² Ù…ÙˆØ§Ø¯</span>
                                </div>
                                <div class="text-right">
                                    <span id="lbl-final-price" class="text-3xl font-black text-teal-400 tracking-tight drop-shadow-sm">0</span>
                                    <span class="text-xs text-slate-500 mr-1">ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- >>> TAB 2: MATERIALS (Ø§Ù†Ø¨Ø§Ø±) <<< -->
        <div id="tab-materials" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§ -->
                <div class="md:col-span-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 sticky top-24">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-3 flex items-center gap-2">
                            <span class="text-xl">ğŸ“¦</span> Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§
                        </h3>
                        <form onsubmit="handleSaveMaterial(event)" id="material-form" class="space-y-4">
                            <input type="hidden" id="mat-id">
                            
                            <div>
                                <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                                <select id="mat-category" class="input-field bg-slate-50">
                                    <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù„Ø§</label>
                                <input type="text" id="mat-name" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ù¾Ø±ÙˆÙÛŒÙ„ Û´Û°Ã—Û´Û°" required>
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="w-1/3">
                                    <label class="form-label">ÙˆØ§Ø­Ø¯</label>
                                    <input type="text" id="mat-unit" class="input-field text-center" placeholder="Ú©ÛŒÙ„Ùˆ/Ø´Ø§Ø®Ù‡" required>
                                </div>
                                <div class="flex-grow">
                                    <label class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</label>
                                    <input type="text" id="mat-price" class="input-field price-input text-teal-700" placeholder="0" oninput="formatInput(this)" required>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 pt-2">
                                <button type="submit" id="mat-submit-btn" class="btn btn-primary flex-grow shadow-md">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±</button>
                                <button type="button" id="mat-cancel-btn" onclick="resetMaterialForm()" class="btn btn-secondary hidden">Ù„ØºÙˆ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ -->
                <div class="md:col-span-8">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 min-h-[600px]">
                        <div class="flex flex-wrap gap-3 mb-6">
                            <div class="relative flex-grow">
                                <input type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ú©Ø§Ù„Ø§..." oninput="renderMaterials(this.value)" class="input-field pl-10">
                                <span class="absolute left-3 top-2.5 text-slate-400">ğŸ”</span>
                            </div>
                            <select id="sort-materials" onchange="renderMaterials()" class="input-field w-auto text-xs">
                                <option value="name_asc">Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§</option>
                                <option value="date_desc">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª</option>
                                <option value="price_desc">Ú¯Ø±Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
                                <option value="price_asc">Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
                            </select>
                        </div>
                        <div id="materials-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù„Ø§ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- >>> TAB 3: CATEGORIES (Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§) <<< -->
        <div id="tab-categories" class="hidden">
            <div class="max-w-lg mx-auto bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mt-10">
                <div class="text-center mb-6">
                    <span class="text-4xl block mb-2">ğŸ“‚</span>
                    <h3 class="font-bold text-slate-700 text-lg">Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</h3>
                    <p class="text-xs text-slate-400 mt-1">Ø¨Ø±Ø§ÛŒ Ù†Ø¸Ù… Ø¯Ù‡ÛŒ Ø¨Ù‡ Ø§Ù†Ø¨Ø§Ø± Ùˆ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø±Ø§Ø­Øªâ€ŒØªØ±</p>
                </div>
                
                <form onsubmit="handleAddCategory(event)" class="flex gap-2 mb-6">
                    <input type="text" id="cat-name" class="input-field" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯..." required>
                    <button class="btn btn-primary whitespace-nowrap">Ø§ÙØ²ÙˆØ¯Ù† +</button>
                </form>
                
                <div id="category-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-1">
                    <!-- Ù„ÛŒØ³Øª Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ -->
                </div>
            </div>
        </div>

        <!-- >>> TAB 4: STORE (ÙØ±ÙˆØ´Ú¯Ø§Ù‡) <<< -->
        <div id="tab-store" class="hidden">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-8 rounded-3xl shadow-xl mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-2xl font-black mb-2">Ø¨Ø§Ù†Ú© Ø¯Ø§Ø¯Ù‡ Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡</h2>
                    <p class="text-indigo-100 text-sm max-w-lg leading-relaxed">
                        Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ØµÙ†Ø¹Øª. Ø¨Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ Ù…Ø¬Ø¯Ø¯ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.
                    </p>
                </div>
                <div class="absolute right-0 top-0 h-full w-64 bg-white/10 -skew-x-12 transform origin-bottom-right"></div>
            </div>
            <div id="store-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ -->
                <p class="col-span-full text-center text-slate-400 py-10">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ù†Ú© Ø¯Ø§Ø¯Ù‡...</p>
            </div>
        </div>

    </div>

    <!-- =========================================
         4. Modals (Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ù¾â€ŒØ¢Ù¾)
         ========================================= -->

    <!-- MODAL: ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ -->
    <div id="new-formula-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-100">
            <h3 class="font-bold text-slate-800 mb-4 text-lg flex items-center gap-2">
                <span class="bg-teal-100 text-teal-700 p-1 rounded">âœ¨</span>
                ØªØ¹Ø±ÛŒÙ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯
            </h3>
            <p class="text-xs text-slate-500 mb-4">ÛŒÚ© Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„ ÛŒØ§ Ø³Ø§Ø²Ù‡ Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
            <input type="text" id="new-formula-name" class="input-field mb-6 text-center font-bold text-lg" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„..." autofocus>
            <div class="flex gap-3">
                <button onclick="handleCreateFormula()" class="btn btn-primary flex-1 py-3">Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø´Ø±ÙˆØ¹ Ø·Ø±Ø§Ø­ÛŒ</button>
                <button onclick="closeModal('new-formula-modal')" class="btn btn-secondary flex-1">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Ù¾Ø±ÛŒÙ†Øª (ÙØ§Ú©ØªÙˆØ± Ø±Ø³Ù…ÛŒ) -->
    <div id="print-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-3xl max-h-[95vh] overflow-y-auto rounded-2xl shadow-2xl flex flex-col" id="print-wrapper">
            
            <!-- Ù†Ø§Ø­ÛŒÙ‡ Ù‚Ø§Ø¨Ù„ Ú†Ø§Ù¾ -->
            <div class="p-8 md:p-12 bg-white text-slate-900" id="print-area">
                
                <!-- Ø³Ø±Ø¨Ø±Ú¯ ÙØ§Ú©ØªÙˆØ± -->
                <div class="flex justify-between items-start border-b-4 border-slate-800 pb-6 mb-8">
                    <div>
                        <h1 class="text-3xl font-black text-slate-900 tracking-tight">Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</h1>
                        <p class="text-sm text-slate-500 mt-2 font-medium">ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ù†Ú©Ø³ Ùˆ Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡</p>
                    </div>
                    <div class="text-left">
                        <div class="text-4xl font-black text-slate-200 tracking-tighter">INVOICE</div>
                        <div class="text-sm font-bold text-teal-700 mt-1 uppercase">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</div>
                        <div class="text-xs font-mono text-slate-400 mt-2" id="print-date">1403/01/01</div>
                    </div>
                </div>

                <!-- Ù…Ø´Ø®ØµØ§Øª Ù…Ø­ØµÙˆÙ„ -->
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Ø´Ø±Ø­ Ù…Ø­ØµÙˆÙ„ / Ù¾Ø±ÙˆÚ˜Ù‡</div>
                        <div class="text-xl font-bold text-slate-800" id="print-title">---</div>
                    </div>
                    <div class="text-left">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</div>
                        <div class="text-xs font-mono bg-white border px-2 py-1 rounded text-slate-500" id="print-id">---</div>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ù„Ø§Ù… -->
                <table class="w-full text-sm mb-8 border-collapse">
                    <thead>
                        <tr class="border-b-2 border-slate-800 text-slate-700">
                            <th class="text-right py-3 font-bold">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Ø§Øª</th>
                            <th class="text-center py-3 w-20 font-bold">ØªØ¹Ø¯Ø§Ø¯</th>
                            <th class="text-center py-3 w-20 font-bold">ÙˆØ§Ø­Ø¯</th>
                        </tr>
                    </thead>
                    <tbody id="print-rows" class="text-slate-600 font-medium divide-y divide-slate-100">
                        <!-- Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ -->
                    </tbody>
                </table>

                <!-- Ø¨Ø§Ú©Ø³ Ø¬Ù…Ø¹ Ù†Ù‡Ø§ÛŒÛŒ -->
                <div class="flex justify-end">
                    <div class="w-full md:w-1/2 lg:w-1/3 space-y-3 text-sm">
                        <div class="flex justify-between text-slate-500">
                            <span>Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ (Ù…ÙˆØ§Ø¯ + Ø³Ø±Ø¨Ø§Ø±):</span>
                            <span class="font-mono font-bold" id="print-base">0</span>
                        </div>
                        <div class="flex justify-between text-teal-700">
                            <span>Ø³ÙˆØ¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡:</span>
                            <span class="font-mono font-bold" id="print-profit">0</span>
                        </div>
                        <div class="flex justify-between text-slate-800 pt-2 border-t border-slate-200">
                            <span class="font-bold">Ø¬Ù…Ø¹ Ú©Ù„ (Ø¨Ø¯ÙˆÙ† Ù…Ø§Ù„ÛŒØ§Øª):</span>
                            <span class="font-mono font-bold" id="print-subtotal">0</span>
                        </div>
                        <div class="flex justify-between text-amber-600">
                            <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (10%):</span>
                            <span class="font-mono font-bold" id="print-vat">0</span>
                        </div>
                        
                        <div class="bg-slate-800 text-white p-4 rounded-xl flex justify-between items-center mt-4 shadow-lg">
                            <span class="font-bold text-slate-300">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                            <div class="text-right">
                                <span class="font-mono font-black text-2xl text-white block leading-none" id="print-final">0</span>
                                <span class="text-[10px] text-slate-400">ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-12 pt-6 border-t border-slate-100 text-center text-[10px] text-slate-400">
                    Ø§ÛŒÙ† Ø³Ù†Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø³ÛŒØ³ØªÙ…ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ùˆ ØªØ§ Û²Û´ Ø³Ø§Ø¹Øª Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±Ø¯.
                </div>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ (Ø¯Ø± Ú†Ø§Ù¾ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯) -->
            <div class="bg-slate-50 p-4 border-t border-slate-200 flex justify-center gap-3 no-print rounded-b-2xl">
                <button onclick="window.print()" class="btn btn-primary shadow-lg px-8 text-lg">ğŸ–¨ Ú†Ø§Ù¾ / Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
                <button onclick="closeModal('print-modal')" class="btn btn-secondary px-6">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <!-- =========================================
         5. JavaScript Logic (Ù…Ù†Ø·Ù‚ Ø¨Ø±Ù†Ø§Ù…Ù‡)
         ========================================= -->
    <script>
        // ----------------------------------------------------
        // CONFIGURATION (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³)
        // ----------------------------------------------------
        const APPWRITE_CONFIG = {
            ENDPOINT: 'https://cloud.appwrite.io/v1',
            PROJECT_ID: '691c9337000c1532f26a', 
            DB_ID: '691c956400150133e319',
            COLS: { 
                CATS: 'categories', 
                MATS: 'materials', 
                FORMS: 'formulas' 
            }
        };

        // ----------------------------------------------------
        // APPWRITE SETUP
        // ----------------------------------------------------
        let client, account, db;
        let state = { 
            categories: [], 
            materials: [], 
            formulas: [], 
            activeFormulaId: null, 
            publicFormulas: [] 
        };

        // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ SDK
        if (typeof Appwrite === 'undefined') {
            showError("Ø®Ø·Ø§: Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Appwrite Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ VPN Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        } else {
            const { Client, Account, Databases, ID, Query } = Appwrite;
            client = new Client()
                .setEndpoint(APPWRITE_CONFIG.ENDPOINT)
                .setProject(APPWRITE_CONFIG.PROJECT_ID);
            account = new Account(client);
            db = new Databases(client);
            
            // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
            init();
        }

        // ----------------------------------------------------
        // CORE FUNCTIONS (ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ)
        // ----------------------------------------------------
        async function init() {
            try {
                // 1. Auth (ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³)
                try { 
                    await account.get(); 
                } catch (e) { 
                    console.log("No session, creating anonymous...");
                    await account.createAnonymousSession(); 
                }

                // 2. Load Data
                await loadAllData();

                // 3. UI Ready
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                showError("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.");
            }
        }

        async function loadAllData() {
            const { Query } = Appwrite;
            // Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
            const [cRes, mRes, fRes] = await Promise.all([
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, [Query.limit(100)]),
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, [Query.limit(5000)]),
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, [Query.limit(500)])
            ]);

            state.categories = cRes.documents;
            state.materials = mRes.documents;
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® ÙˆÛŒØ±Ø§ÛŒØ´ (Ù†Ø²ÙˆÙ„ÛŒ)
            state.formulas = fRes.documents.sort((a, b) => new Date(b.$updatedAt) - new Date(a.$updatedAt));

            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            try {
                const sRes = await db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, [
                    Query.equal('is_public', true),
                    Query.limit(50)
                ]);
                state.publicFormulas = sRes.documents;
            } catch (e) {
                console.warn("Store access issue (Index missing?):", e);
            }

            updateUI();
        }

        function updateUI() {
            renderCategories();
            renderMaterials();
            renderFormulaList();
            renderStore();
            updateDropdowns();
            
            // Ø§Ú¯Ø± ÙØ±Ù…ÙˆÙ„ÛŒ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†
            if (state.activeFormulaId) {
                // Ú†Ú© Ú©Ù† Ú©Ù‡ Ø­Ø°Ù Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                if (state.formulas.find(f => f.$id === state.activeFormulaId)) {
                    renderFormulaDetail(state.activeFormulaId);
                } else {
                    state.activeFormulaId = null;
                    document.getElementById('formula-detail-view').classList.add('hidden');
                    document.getElementById('formula-detail-empty').classList.remove('hidden');
                }
            }
        }

        function showError(msg) {
            const el = document.getElementById('loading-text');
            if(el) {
                el.innerText = msg;
                el.classList.add('text-red-400', 'font-bold');
            } else {
                alert(msg);
            }
        }

        // ----------------------------------------------------
        // DOM & UI HELPERS
        // ----------------------------------------------------
        function switchTab(tabId) {
            // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ØªØ¨â€ŒÙ‡Ø§
            ['formulas', 'materials', 'categories', 'store'].forEach(id => {
                const section = document.getElementById('tab-' + id);
                const btn = document.getElementById('btn-' + id);
                if(section) section.classList.add('hidden');
                if(btn) btn.classList.remove('active');
            });
            
            // Ù†Ù…Ø§ÛŒØ´ ØªØ¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            const target = document.getElementById('tab-' + tabId);
            const targetBtn = document.getElementById('btn-' + tabId);
            if(target) target.classList.remove('hidden');
            if(targetBtn) targetBtn.classList.add('active');
        }

        function openModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.classList.add('flex');
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('flex');
            el.classList.add('hidden');
        }

        // ÙØ±Ù…Øª Ù‚ÛŒÙ…Øª (Û±Û°Û°Û° -> Û±,Û°Û°Û°)
        function formatPrice(num) {
            if(num === undefined || num === null) return '0';
            return Number(num).toLocaleString('en-US');
        }

        // ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾
        function formatInput(el) {
            const raw = el.value.replace(/[^0-9.]/g, '');
            if(raw) el.value = parseFloat(raw).toLocaleString('en-US');
            else el.value = '';
        }

        // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        function formatDate(isoStr) {
            if(!isoStr) return '';
            return new Date(isoStr).toLocaleDateString('fa-IR');
        }

        // ----------------------------------------------------
        // LOGIC: MATERIALS (Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡)
        // ----------------------------------------------------
        async function handleSaveMaterial(e) {
            e.preventDefault();
            const { ID } = Appwrite;
            const id = document.getElementById('mat-id').value;
            
            const rawPrice = document.getElementById('mat-price').value.replace(/,/g, '');
            const data = {
                name: document.getElementById('mat-name').value,
                unit: document.getElementById('mat-unit').value,
                price: parseFloat(rawPrice) || 0,
                category_id: document.getElementById('mat-category').value || null
            };

            try {
                if (id) {
                    await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, id, data);
                } else {
                    await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, ID.unique(), data);
                }
                resetMaterialForm();
                loadAllData(); // Ø±ÙØ±Ø´
            } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: " + err.message); }
        }

        function renderMaterials(filterText = '') {
            const container = document.getElementById('materials-container');
            const sortMode = document.getElementById('sort-materials').value;
            
            let list = state.materials.filter(m => m.name.includes(filterText));
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
            list.sort((a, b) => {
                switch(sortMode) {
                    case 'price_desc': return b.price - a.price;
                    case 'price_asc': return a.price - b.price;
                    case 'date_desc': return new Date(b.$updatedAt) - new Date(a.$updatedAt);
                    default: return a.name.localeCompare(b.name);
                }
            });

            if (list.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400">Ú©Ø§Ù„Ø§ÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }

            container.innerHTML = list.map(m => {
                const catName = state.categories.find(c => c.$id === m.category_id)?.name || 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡';
                const isRecent = (new Date() - new Date(m.$updatedAt)) / (1000*60*60*24) < 7; // Ø²ÛŒØ± 7 Ø±ÙˆØ²

                return `
                <div class="bg-white p-3 rounded-xl border border-slate-100 hover:border-teal-400 transition-all group relative hover:shadow-md">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${catName}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editMaterial('${m.$id}')" class="text-amber-500 hover:bg-amber-50 p-1 rounded">âœ</button>
                            <button onclick="deleteDoc('${APPWRITE_CONFIG.COLS.MATS}', '${m.$id}')" class="text-rose-500 hover:bg-rose-50 p-1 rounded">Ã—</button>
                        </div>
                    </div>
                    <div class="font-bold text-sm text-slate-800 truncate mb-2" title="${m.name}">${m.name}</div>
                    <div class="flex justify-between items-end border-t border-slate-50 pt-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-400">${m.unit}</span>
                            <span class="badge ${isRecent ? 'badge-green' : 'badge-orange'} mt-1">${formatDate(m.$updatedAt)}</span>
                        </div>
                        <span class="font-mono font-bold text-teal-700 text-lg">${formatPrice(m.price)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function editMaterial(id) {
            const m = state.materials.find(x => x.$id === id);
            if(!m) return;
            
            document.getElementById('mat-id').value = m.$id;
            document.getElementById('mat-name').value = m.name;
            document.getElementById('mat-unit').value = m.unit;
            document.getElementById('mat-price').value = formatPrice(m.price);
            document.getElementById('mat-category').value = m.category_id || "";
            
            // ØªØºÛŒÛŒØ± Ø¯Ú©Ù…Ù‡
            const btn = document.getElementById('mat-submit-btn');
            btn.innerText = 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù„Ø§';
            btn.className = 'btn bg-amber-500 text-white flex-grow shadow-md hover:bg-amber-600';
            document.getElementById('mat-cancel-btn').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetMaterialForm() {
            document.getElementById('material-form').reset();
            document.getElementById('mat-id').value = '';
            const btn = document.getElementById('mat-submit-btn');
            btn.innerText = 'Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±';
            btn.className = 'btn btn-primary flex-grow shadow-md';
            document.getElementById('mat-cancel-btn').classList.add('hidden');
        }

        // ----------------------------------------------------
        // LOGIC: CATEGORIES (Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ)
        // ----------------------------------------------------
        async function handleAddCategory(e) {
            e.preventDefault();
            const { ID } = Appwrite;
            const name = document.getElementById('cat-name').value.trim();
            if(!name) return;
            
            try {
                await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, ID.unique(), { name });
                document.getElementById('cat-name').value = '';
                loadAllData();
            } catch (e) { alert(e.message); }
        }

        function renderCategories() {
            const list = document.getElementById('category-list');
            if (state.categories.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 py-4">Ø¯Ø³ØªÙ‡ Ø§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }
            list.innerHTML = state.categories.map(c => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100 group">
                    <span class="font-bold text-sm text-slate-700">${c.name}</span>
                    <button onclick="deleteDoc('${APPWRITE_CONFIG.COLS.CATS}', '${c.$id}')" class="text-slate-300 hover:text-rose-500 transition-colors px-2">ğŸ—‘</button>
                </div>
            `).join('');
        }

        // ----------------------------------------------------
        // LOGIC: FORMULAS (Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª)
        // ----------------------------------------------------
        async function handleCreateFormula() {
            const { ID } = Appwrite;
            const name = document.getElementById('new-formula-name').value.trim();
            if(!name) return;
            
            try {
                const res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, ID.unique(), {
                    name,
                    components_json: '[]',
                    labor: 0.0, overhead: 0.0, profit: 0.0,
                    is_public: false
                });
                state.formulas.unshift(res);
                document.getElementById('new-formula-name').value = '';
                closeModal('new-formula-modal');
                selectFormula(res.$id);
            } catch(e) { alert(e.message); }
        }

        function renderFormulaList(filter = '') {
            const el = document.getElementById('formula-master-list');
            const filtered = state.formulas.filter(f => f.name.includes(filter));
            
            if(filtered.length === 0) {
                el.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            el.innerHTML = filtered.map(f => `
                <div onclick="selectFormula('${f.$id}')" 
                     class="p-3 border-b border-slate-50 cursor-pointer hover:bg-teal-50 transition-colors group ${f.$id === state.activeFormulaId ? 'bg-teal-50 border-r-4 border-teal-600' : ''}">
                    <div class="font-bold text-sm text-slate-700 group-hover:text-teal-700 transition-colors">${f.name}</div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-[10px] text-slate-400">${formatDate(f.$updatedAt)}</span>
                        ${f.is_public ? '<span class="text-[8px] bg-purple-100 text-purple-600 px-1 rounded">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function selectFormula(id) {
            state.activeFormulaId = id;
            renderFormulaList(); // Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ú©ØªÛŒÙˆ
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª
            document.getElementById('formula-detail-empty').classList.add('hidden');
            const view = document.getElementById('formula-detail-view');
            view.classList.remove('hidden');
            view.classList.add('flex');
            
            renderFormulaDetail(id);
        }

        // *** Ù‚Ù„Ø¨ ØªÙ¾Ù†Ø¯Ù‡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª (Recursive) ***
        function calculateCost(f) {
            if (!f) return { matCost: 0, sub: 0, profit: 0, final: 0 };

            let matCost = 0;
            const comps = JSON.parse(f.components_json || '[]');

            comps.forEach(c => {
                if (c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if (m) matCost += m.price * c.qty;
                } else if (c.type === 'form') {
                    const subF = state.formulas.find(x => x.$id === c.id);
                    // Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ: Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø±Ø§ Ø­Ø³Ø§Ø¨ Ú©Ù†
                    if (subF) matCost += calculateCost(subF).final * c.qty; 
                }
            });

            const labor = f.labor || 0;
            const overhead = f.overhead || 0;
            const subTotal = matCost + labor + overhead;
            const profitVal = (f.profit || 0) / 100 * subTotal;
            const finalPrice = subTotal + profitVal;

            return { matCost, sub: subTotal, profit: profitVal, final: finalPrice };
        }

        function renderFormulaDetail(id) {
            const f = state.formulas.find(x => x.$id === id);
            if(!f) return;

            const calc = calculateCost(f);
            const comps = JSON.parse(f.components_json || '[]');

            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ùˆ Ù¾Ø§ÛŒÛŒÙ†
            document.getElementById('active-formula-name').innerText = f.name;
            document.getElementById('active-formula-date').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: ' + formatDate(f.$updatedAt);
            document.getElementById('inp-labor').value = formatPrice(f.labor);
            document.getElementById('inp-overhead').value = formatPrice(f.overhead);
            document.getElementById('inp-profit').value = f.profit;
            document.getElementById('lbl-final-price').innerText = formatPrice(calc.final);

            // Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ† Ø§ÙØ²ÙˆØ¯Ù†
            updateComponentSelect();

            // Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ø¬Ø²Ø§
            const list = document.getElementById('formula-comps-list');
            if(comps.length === 0) {
                list.innerHTML = '<div class="p-10 text-center text-slate-400 text-sm flex flex-col items-center"><span class="text-2xl mb-2 opacity-50">ğŸ§©</span>Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù…ÙˆØ§Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }

            list.innerHTML = comps.map((c, idx) => {
                let name = 'Ù†Ø§Ù…Ø´Ø®Øµ', unit = '-', unitPrice = 0, totalPrice = 0;
                let isError = false;

                if (c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if (m) {
                        name = m.name;
                        unit = m.unit;
                        unitPrice = m.price;
                    } else {
                        name = 'Ú©Ø§Ù„Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡';
                        isError = true;
                    }
                } else {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    if (sub) {
                        name = `ğŸ”— ${sub.name}`;
                        unit = 'Ø¹Ø¯Ø¯';
                        unitPrice = calculateCost(sub).final;
                    } else {
                        name = 'Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´Ø¯Ù‡';
                        isError = true;
                    }
                }

                totalPrice = unitPrice * c.qty;

                return `
                <div class="flex justify-between items-center p-3 text-sm hover:bg-slate-100 group transition-colors ${isError ? 'bg-rose-50' : ''}">
                    <div class="flex-grow">
                        <div class="font-bold text-slate-700 ${isError ? 'text-rose-500' : ''}">${name}</div>
                        <div class="text-xs text-slate-400 mt-0.5">
                            <span class="font-mono bg-white px-1 border rounded text-slate-600">${c.qty}</span> 
                            ${unit} Ã— 
                            <span class="font-mono">${formatPrice(unitPrice)}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-mono font-bold text-slate-600">${formatPrice(totalPrice)}</span>
                        <button onclick="removeComp('${id}', ${idx})" class="text-slate-300 hover:text-rose-500 p-1 rounded opacity-0 group-hover:opacity-100 transition-all">âœ–</button>
                    </div>
                </div>`;
            }).join('');
        }

        // Ø¹Ù…Ù„ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„: Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø²Ø¡
        async function addComp(e) {
            e.preventDefault();
            if(!state.activeFormulaId) return;

            const val = document.getElementById('comp-select').value;
            const qty = parseFloat(document.getElementById('comp-qty').value);
            
            if(!val || !qty) return;

            const [typePrefix, itemId] = val.split(':');
            const type = typePrefix === 'MAT' ? 'mat' : 'form';
            const fid = state.activeFormulaId;

            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Circular Dependency (ÙØ±Ù…ÙˆÙ„ A Ø´Ø§Ù…Ù„ ÙØ±Ù…ÙˆÙ„ A Ù†Ø´ÙˆØ¯)
            if(type === 'form' && itemId === fid) {
                alert("Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø¯Ø±ÙˆÙ† Ø®ÙˆØ¯Ø´ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯!");
                return;
            }

            const f = state.formulas.find(x => x.$id === fid);
            let comps = JSON.parse(f.components_json || '[]');

            // Ú†Ú© ØªÚ©Ø±Ø§Ø±ÛŒ
            const existing = comps.find(c => c.id === itemId && c.type === type);
            if (existing) {
                existing.qty += qty;
            } else {
                comps.push({ id: itemId, type, qty });
            }

            try {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, {
                    components_json: JSON.stringify(comps)
                });
                
                // Ø±ÛŒØ³Øª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
                document.getElementById('comp-qty').value = '';
                
                loadAllData();
            } catch(err) { alert(err.message); }
        }

        // Ø¹Ù…Ù„ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„: Ø­Ø°Ù Ø¬Ø²Ø¡
        async function removeComp(fid, idx) {
            const f = state.formulas.find(x => x.$id === fid);
            let comps = JSON.parse(f.components_json || '[]');
            comps.splice(idx, 1);
            
            await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, {
                components_json: JSON.stringify(comps)
            });
            loadAllData();
        }

        // Ø¹Ù…Ù„ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„: ØªØºÛŒÛŒØ± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
        async function updateCost(field, val) {
            if(!state.activeFormulaId) return;
            const num = parseFloat(val.replace(/,/g, '')) || 0;
            await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, state.activeFormulaId, {
                [field]: num
            });
            loadAllData();
        }

        // Ø¹Ù…Ù„ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„: ØªØºÛŒÛŒØ± Ù†Ø§Ù…
        async function editFormulaName() {
            if(!state.activeFormulaId) return;
            const currentName = document.getElementById('active-formula-name').innerText;
            const newName = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù…Ø­ØµÙˆÙ„:", currentName);
            if (newName && newName !== currentName) {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, state.activeFormulaId, { name: newName });
                loadAllData();
            }
        }

        // Ø¹Ù…Ù„ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„: Ø­Ø°Ù Ú©Ù„
        async function deleteFormula() {
            if(!state.activeFormulaId) return;
            if(confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")) {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, state.activeFormulaId);
                // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ UI
                state.activeFormulaId = null;
                document.getElementById('formula-detail-view').classList.add('hidden');
                document.getElementById('formula-detail-view').classList.remove('flex');
                document.getElementById('formula-detail-empty').classList.remove('hidden');
                
                loadAllData();
            }
        }

        // ----------------------------------------------------
        // LOGIC: PRINT & EXPORT
        // ----------------------------------------------------
        function printFormula() {
            if(!state.activeFormulaId) return;
            const f = state.formulas.find(x => x.$id === state.activeFormulaId);
            const calc = calculateCost(f);
            const comps = JSON.parse(f.components_json || '[]');

            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù‡Ø¯Ø±
            document.getElementById('print-title').innerText = f.name;
            document.getElementById('print-id').innerText = f.$id.substring(0, 8).toUpperCase();
            document.getElementById('print-date').innerText = new Date().toLocaleDateString('fa-IR');

            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„
            const rowsHTML = comps.map(c => {
                let name, unit;
                if(c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    name = m ? m.name : 'Ø­Ø°Ù Ø´Ø¯Ù‡';
                    unit = m ? m.unit : '-';
                } else {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    name = sub ? sub.name + ' (Ø³Ø§Ø²Ù‡ Ø¢Ù…Ø§Ø¯Ù‡)' : 'Ø­Ø°Ù Ø´Ø¯Ù‡';
                    unit = 'Ø¯Ø³ØªÚ¯Ø§Ù‡';
                }
                return `
                    <tr class="border-b border-slate-100 last:border-0">
                        <td class="py-3 text-right text-slate-700">${name}</td>
                        <td class="py-3 text-center font-mono bg-slate-50 text-slate-600">${c.qty}</td>
                        <td class="py-3 text-center text-slate-500 text-xs">${unit}</td>
                    </tr>`;
            }).join('');
            
            document.getElementById('print-rows').innerHTML = rowsHTML;

            // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒØ§Øª Ùˆ Ø¬Ù…Ø¹
            // Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ = Ù…ÙˆØ§Ø¯ + Ø³Ø±Ø¨Ø§Ø± + Ø¯Ø³ØªÙ…Ø²Ø¯ (Ø¨Ø¯ÙˆÙ† Ø³ÙˆØ¯)
            // Ø§Ù…Ø§ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¯Ø± ÙØ§Ú©ØªÙˆØ± Ù…Ø´ØªØ±ÛŒ: (Ù…ÙˆØ§Ø¯ + Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ + Ø³ÙˆØ¯) = Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ Ù…Ø§Ù„ÛŒØ§Øª
            
            const priceBeforeTax = calc.final; 
            const vat = Math.round(priceBeforeTax * 0.10); // 10%
            const priceTotal = priceBeforeTax + vat;

            // Ù†Ù…Ø§ÛŒØ´: Ù¾Ø§ÛŒÙ‡ (ÙÙ‚Ø· Ù…ÙˆØ§Ø¯ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡) | Ø³ÙˆØ¯ | Ø¬Ù…Ø¹ | Ù…Ø§Ù„ÛŒØ§Øª | Ù†Ù‡Ø§ÛŒÛŒ
            // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ "Ù¾Ø§ÛŒÙ‡" Ø¯Ø± ÙØ§Ú©ØªÙˆØ±ØŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¬Ù…Ø¹ Ù…ØªØ±ÛŒØ§Ù„ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            document.getElementById('print-base').innerText = formatPrice(calc.sub);
            document.getElementById('print-profit').innerText = formatPrice(calc.profit);
            document.getElementById('print-subtotal').innerText = formatPrice(priceBeforeTax);
            document.getElementById('print-vat').innerText = formatPrice(vat);
            document.getElementById('print-final').innerText = formatPrice(priceTotal);

            openModal('print-modal');
        }

        // ----------------------------------------------------
        // LOGIC: DROPDOWNS & HELPERS
        // ----------------------------------------------------
        function updateDropdowns() {
            // Ø¯Ø± ØªØ¨ Ù…ÙˆØ§Ø¯:
            const catSel = document.getElementById('mat-category');
            const currentMatCat = catSel.value;
            catSel.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡ --</option>' + 
                state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('');
            catSel.value = currentMatCat;

            // Ø¯Ø± ØªØ¨ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (ÙÛŒÙ„ØªØ±):
            const filterSel = document.getElementById('comp-filter');
            const currentFilter = filterSel.value;
            filterSel.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§...</option>' + 
                state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('') + 
                '<option value="FORM">Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯ÛŒÚ¯Ø± (ØªÙˆØ¯Ø±ØªÙˆ)</option>';
            filterSel.value = currentFilter;
            
            updateComponentSelect();
        }

        function updateComponentSelect() {
            const filter = document.getElementById('comp-filter').value;
            const select = document.getElementById('comp-select');
            
            // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯ Ù‡Ø³ØªÛŒÙ… Ùˆ Ø§Ù„Ù…Ù†ØªÛŒ Ù†ÛŒØ³Øª
            if(!select) return;

            let html = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
            
            if (filter === 'FORM') {
                // ÙÙ‚Ø· ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (Ø¨Ù‡ Ø¬Ø² Ø®ÙˆØ¯Ø´)
                const validFormulas = state.formulas.filter(f => f.$id !== state.activeFormulaId);
                if(validFormulas.length) {
                    html += `<optgroup label="Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡">` + 
                        validFormulas.map(f => `<option value="FORM:${f.$id}">ğŸ”— ${f.name}</option>`).join('') + 
                        `</optgroup>`;
                }
            } else {
                // Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ (Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡)
                state.categories.forEach(c => {
                    // Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± Ø¯Ø§Ø±ÛŒÙ… Ùˆ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ù†ÛŒØ³ØªØŒ Ø±Ø¯ Ú©Ù†
                    if(filter && filter !== 'FORM' && filter !== c.$id) return;
                    
                    const mats = state.materials.filter(m => m.category_id === c.$id);
                    if(mats.length > 0) {
                        html += `<optgroup label="${c.name}">` + 
                            mats.map(m => `<option value="MAT:${m.$id}">${m.name}</option>`).join('') + 
                            `</optgroup>`;
                    }
                });

                // Ù…ÙˆØ§Ø¯ Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡
                const otherMats = state.materials.filter(m => !m.category_id);
                if (otherMats.length > 0 && (!filter || filter === 'null')) {
                    html += `<optgroup label="Ø³Ø§ÛŒØ±">` + 
                        otherMats.map(m => `<option value="MAT:${m.$id}">${m.name}</option>`).join('') + 
                        `</optgroup>`;
                }
            }
            select.innerHTML = html;
        }

        async function deleteDoc(col, id) {
            if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
                try {
                    await db.deleteDocument(APPWRITE_CONFIG.DB_ID, col, id);
                    loadAllData();
                } catch(e) { alert(e.message); }
            }
        }

        // ----------------------------------------------------
        // LOGIC: STORE
        // ----------------------------------------------------
        function renderStore() {
            const el = document.getElementById('store-container');
            if(state.publicFormulas.length === 0) {
                el.innerHTML = '<div class="col-span-full text-center p-8 border-2 border-dashed border-slate-200 rounded-xl text-slate-400">Ù‡ÛŒÚ† Ø¢ÛŒØªÙ… Ø¹Ù…ÙˆÙ…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                return;
            }
            el.innerHTML = state.publicFormulas.map(f => `
                <div class="bg-white p-5 rounded-2xl border border-indigo-100 shadow-sm hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-slate-800 text-lg">${f.name}</h3>
                        <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100">Ø±Ø³Ù…ÛŒ</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ø±ÛŒØ² Ù…ÙˆØ§Ø¯ Ù…ØµØ±ÙÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯.</p>
                    <button onclick="copyTemplate('${f.$id}')" class="w-full py-2 rounded-xl font-bold bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-colors text-sm">
                        ğŸ“¥ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ù†
                    </button>
                </div>
            `).join('');
        }

        async function copyTemplate(id) {
            const { ID } = Appwrite;
            if(!confirm("Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ØŸ")) return;
            
            const t = state.publicFormulas.find(x => x.$id === id);
            if(!t) return;

            try {
                await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, ID.unique(), {
                    name: t.name + ' (Ú©Ù¾ÛŒ)',
                    components_json: t.components_json,
                    labor: t.labor,
                    overhead: t.overhead,
                    profit: t.profit,
                    is_public: false
                });
                alert("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ø¨Ù‡ ØªØ¨ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø±ÙˆÛŒØ¯.");
                loadAllData();
                switchTab('formulas');
            } catch(e) { alert(e.message); }
        }

    </script>
</body>
</html>
