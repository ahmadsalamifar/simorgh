<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ†Øª Ùˆ Ø§Ø³ØªØ§ÛŒÙ„ Ù¾Ø§ÛŒÙ‡ */
        body { font-family: 'Vazirmatn', sans-serif; @apply bg-slate-50 text-slate-800; padding-bottom: 100px; }
        
        /* Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ */
        .form-label { @apply block text-sm font-bold text-teal-800 mb-2; }
        .input-field { 
            @apply w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white transition-all shadow-sm text-sm; 
        }
        .input-field:focus { @apply border-teal-500 ring-2 ring-teal-100; }
        
        /* Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ */
        input[type="number"], .price-input { direction: ltr; text-align: left; font-family: monospace; font-weight: 700; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { 
            @apply px-5 py-2.5 rounded-xl font-bold transition-all transform active:scale-95 shadow-md flex items-center justify-center gap-2 cursor-pointer select-none; 
        }
        .btn-primary { @apply bg-gradient-to-r from-teal-700 to-cyan-800 text-white hover:from-teal-800 hover:to-cyan-900 shadow-teal-500/20; }
        .btn-danger { @apply bg-rose-50 text-rose-600 border border-rose-200 hover:bg-rose-100; }
        .btn-warning { @apply bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100; }
        .btn-secondary { @apply bg-slate-200 text-slate-700 hover:bg-slate-300; }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card { 
            @apply bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-6 relative overflow-hidden transition-all duration-300 hover:shadow-xl; 
        }
        .card-header { @apply flex justify-between items-center mb-6 border-b border-slate-100 pb-4; }

        /* ØªØ¨â€ŒÙ‡Ø§ */
        .tab-container { @apply flex bg-white p-1 rounded-2xl shadow-sm border border-slate-200 mb-6 mx-4 md:mx-0 overflow-x-auto; }
        .tab-btn { 
            @apply flex-1 py-3 px-4 text-center text-slate-500 rounded-xl font-bold transition-all whitespace-nowrap; 
        }
        .tab-btn.active { @apply bg-teal-50 text-teal-700 shadow-inner; }

        /* Ù†Ø´Ø§Ù†Ú¯Ø± ØªØ§Ø±ÛŒØ® (Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù‡) */
        .update-badge {
            @apply text-[10px] px-2 py-0.5 rounded-full border flex items-center gap-1 whitespace-nowrap;
        }
        .update-badge.new { @apply bg-green-50 text-green-700 border-green-200; }
        .update-badge.old { @apply bg-orange-50 text-orange-700 border-orange-200; }

        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .loader { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #0f766e; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ù…Ø¯Ø§Ù„ (Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø§Ù¾â€ŒØ¢Ù¾) */
        .modal-overlay { @apply fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4; }
        .modal-content { @apply bg-white w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl p-6 animate-[fadeIn_0.2s_ease-out]; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Ø­Ø§Ù„Øª Ù¾Ø±ÛŒÙ†Øª */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white p-4 text-center">
        <div class="loader mb-6" id="loader-spinner"></div>
        <h2 class="text-2xl font-black mb-2">Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</h2>
        <div id="loading-message-box" class="max-w-md">
            <p class="text-slate-400 text-sm" id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù…Ù†...</p>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <div id="app-content" class="max-w-7xl mx-auto p-4 md:p-8 hidden fade-in">
        
        <!-- Ù‡Ø¯Ø± Ø³Ø§ÛŒØª -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div class="text-center md:text-right mb-4 md:mb-0">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">
                    Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ <span class="text-teal-600">Ø³ÛŒÙ…Ø±Øº</span>
                </h1>
                <p class="text-slate-500 text-sm mt-1">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ú©Ø§Ù†Ú©Ø³ Ùˆ Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden md:block px-4 border-l border-slate-200">
                    <p class="text-[10px] text-slate-400 uppercase">ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±</p>
                    <p class="text-sm font-bold text-emerald-600 flex items-center gap-1">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„
                    </p>
                </div>
                <!-- Ø¯Ú©Ù…Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ -->
                <button onclick="switchTab('store')" class="btn bg-purple-50 text-purple-700 border border-purple-100 hover:bg-purple-100">
                    <span class="text-lg">ğŸ¦</span> Ø¨Ø§Ù†Ú© Ø¯Ø§Ø¯Ù‡ (ÙØ±ÙˆØ´Ú¯Ø§Ù‡)
                </button>
            </div>
        </header>

        <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ -->
        <div class="tab-container">
            <button onclick="switchTab('formulas')" class="tab-btn active" id="btn-formulas">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§</button>
            <button onclick="switchTab('materials')" class="tab-btn" id="btn-materials">ğŸ“¦ Ø§Ù†Ø¨Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</button>
            <button onclick="switchTab('categories')" class="tab-btn" id="btn-categories">ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
        </div>

        <!-- =========================================
             ØªØ¨ Û±: Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ (Categories)
             ========================================= -->
        <div id="tab-categories" class="hidden">
            <div class="card max-w-xl mx-auto border-t-4 border-teal-500">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-slate-800">Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù„Ø§</h2>
                </div>
                
                <form onsubmit="handleAddCategory(event)" class="flex gap-2 mb-6">
                    <input type="text" id="cat-name" class="input-field" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø±ÙˆÙÛŒÙ„ØŒ Ø¹Ø§ÛŒÙ‚...)" required>
                    <button type="submit" class="btn btn-primary px-6">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </form>

                <div class="bg-slate-50 rounded-xl p-2 border border-slate-200 max-h-80 overflow-y-auto custom-scrollbar" id="category-list">
                    <!-- Ù„ÛŒØ³Øª Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ -->
                    <p class="text-center text-slate-400 py-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            </div>
        </div>

        <!-- =========================================
             ØªØ¨ Û²: Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ (Materials)
             ========================================= -->
        <div id="tab-materials" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª: ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† -->
                <div class="lg:col-span-4">
                    <div class="card sticky top-4 border-t-4 border-teal-500">
                        <div class="card-header">
                            <h2 class="text-lg font-bold text-slate-800">Ø«Ø¨Øª / ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù„Ø§</h2>
                        </div>
                        <form onsubmit="handleSaveMaterial(event)" id="material-form" class="space-y-4">
                            <input type="hidden" id="mat-id">
                            
                            <div>
                                <label class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                                <select id="mat-category" class="input-field bg-slate-50">
                                    <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù„Ø§</label>
                                <input type="text" id="mat-name" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ù¾Ø±ÙˆÙÛŒÙ„ Û´Û°Ã—Û´Û° Ø³Ù†Ú¯ÛŒÙ†" required>
                            </div>

                            <div class="flex gap-3">
                                <div class="w-1/3">
                                    <label class="form-label">ÙˆØ§Ø­Ø¯</label>
                                    <input type="text" id="mat-unit" class="input-field text-center" placeholder="Ø´Ø§Ø®Ù‡" required>
                                </div>
                                <div class="w-2/3">
                                    <label class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</label>
                                    <input type="text" id="mat-price" class="input-field price-input text-teal-700" placeholder="0" oninput="formatInput(this)" required>
                                </div>
                            </div>

                            <div class="pt-4 flex gap-2">
                                <button type="submit" class="btn btn-primary w-full" id="mat-submit-btn">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±</button>
                                <button type="button" onclick="resetMaterialForm()" id="mat-cancel-btn" class="btn btn-danger hidden">Ù„ØºÙˆ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Ø³ØªÙˆÙ† Ú†Ù¾: Ù„ÛŒØ³Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ -->
                <div class="lg:col-span-8">
                    <div class="card min-h-[600px]">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold text-slate-800">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù†Ø¨Ø§Ø±</h2>
                            
                            <div class="flex gap-2 w-full md:w-auto">
                                <div class="relative flex-grow md:w-64">
                                    <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="renderMaterials(this.value)" class="input-field pl-10">
                                    <span class="absolute left-3 top-3.5 text-slate-400">ğŸ”</span>
                                </div>
                                <select id="sort-materials" onchange="renderMaterials()" class="input-field w-auto text-sm">
                                    <option value="name_asc">Ø§Ù„ÙØ¨Ø§ (ØµØ¹ÙˆØ¯ÛŒ)</option>
                                    <option value="date_desc">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª</option>
                                    <option value="price_desc">Ú¯Ø±Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
                                    <option value="price_asc">Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
                                </select>
                            </div>
                        </div>

                        <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù„Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================================
             ØªØ¨ Û³: ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (Formulas) - Ù…Ø³ØªØ±/Ø¯ÛŒØªÛŒÙ„
             ========================================= -->
        <div id="tab-formulas" class="hidden">
            <!-- Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ -->
            <div class="card mb-6 flex flex-col md:flex-row gap-4 items-center justify-between bg-gradient-to-r from-slate-800 to-slate-700 text-white border-none">
                <div>
                    <h2 class="text-xl font-bold">Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§</h2>
                    <p class="text-slate-300 text-sm mt-1">Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªØ§Ø± Ùˆ Ø¢Ù†Ø§Ù„ÛŒØ² Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡</p>
                </div>
                <button onclick="document.getElementById('new-formula-modal').classList.remove('hidden'); document.getElementById('new-formula-modal').classList.add('flex');" class="btn bg-white text-slate-900 hover:bg-teal-50 border-none shadow-lg">
                    + ØªØ¹Ø±ÛŒÙ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                
                <!-- Ù„ÛŒØ³Øª ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±) -->
                <div class="lg:col-span-4 card p-0 overflow-hidden h-[700px] flex flex-col border-t-4 border-slate-600">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ø­ØµÙˆÙ„Ø§Øª..." oninput="renderFormulaList(this.value)" class="input-field bg-white text-sm">
                    </div>
                    <div id="formula-master-list" class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-100/50">
                        <!-- Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª -->
                    </div>
                </div>

                <!-- Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ±Ù…ÙˆÙ„ (Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ) -->
                <div class="lg:col-span-8">
                    <div id="formula-detail-empty" class="bg-white rounded-3xl shadow-sm border-2 border-dashed border-slate-300 h-[500px] flex flex-col items-center justify-center text-center p-8">
                        <span class="text-6xl mb-4 opacity-20">ğŸ“‹</span>
                        <h3 class="text-xl font-bold text-slate-500">Ù‡Ù†ÙˆØ² Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
                        <p class="text-slate-400 mt-2 max-w-xs">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯.</p>
                    </div>

                    <div id="formula-detail-view" class="hidden space-y-6">
                        <!-- Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================================
             ØªØ¨ Û´: Ø¨Ø§Ù†Ú© Ø¯Ø§Ø¯Ù‡ (Store) - Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ø¯Ø§Ø¯Ù‡
             ========================================= -->
        <div id="tab-store" class="hidden">
            <div class="bg-gradient-to-br from-purple-700 to-indigo-800 rounded-3xl p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø¨Ø§Ù†Ú© Ø¯Ø§Ø¯Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø³ÛŒÙ…Ø±Øº</h2>
                    <p class="text-indigo-200 max-w-xl text-lg">Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ ØµÙ†Ø¹Øª Ú©Ø§Ù†Ú©Ø³. Ø¨Ø§ ÛŒÚ© Ú©Ù„ÛŒÚ©ØŒ Ø¯Ø§Ù†Ø´ ÙÙ†ÛŒ Ø±Ø§ Ø¨Ù‡ Ù¾Ù†Ù„ Ø®ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
                </div>
                <div class="absolute right-0 top-0 h-full w-1/3 bg-white/5 skew-x-12 transform origin-bottom-right"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="store-container">
                <!-- Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                <div class="col-span-full text-center py-12">
                    <div class="loader mx-auto mb-4 border-purple-200 border-t-purple-600"></div>
                    <p class="text-slate-500">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- =========================================
         MODALS (Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ù¾â€ŒØ¢Ù¾)
         ========================================= -->

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ -->
    <div id="new-formula-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-slate-800 mb-4">ØªØ¹Ø±ÛŒÙ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</h3>
            <input type="text" id="new-formula-name" class="input-field mb-6" placeholder="Ù…Ø«Ø§Ù„: Ú©Ø§Ù†Ú©Ø³ Û±Û² Ù…ØªØ±ÛŒ Ø§Ø¯Ø§Ø±ÛŒ..." autofocus>
            <div class="flex gap-3">
                <button onclick="handleCreateFormula()" class="btn btn-primary flex-1">Ø§ÛŒØ¬Ø§Ø¯</button>
                <button onclick="document.getElementById('new-formula-modal').classList.remove('flex'); document.getElementById('new-formula-modal').classList.add('hidden');" class="btn btn-secondary flex-1">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÛŒÙ†Øª (Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±) -->
    <div id="print-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('print-modal')">
        <div class="modal-content" id="print-area">
            <!-- Ø³Ø±Ø¨Ø±Ú¯ Ù¾Ø±ÛŒÙ†Øª -->
            <div class="flex justify-between items-start border-b-4 border-slate-800 pb-6 mb-8">
                <div class="text-right">
                    <h1 class="text-3xl font-black text-slate-900">Ø³ÛŒÙ…Ø±Øº Ú¯Ø³ØªØ± Ù¾ÙˆÛŒØ§</h1>
                    <p class="text-slate-600 mt-2 font-medium">ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù†Ø¯Ù‡ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ù†Ú©Ø³ Ùˆ Ø³Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡</p>
                </div>
                <div class="text-left">
                    <h2 class="text-4xl font-black text-slate-200 tracking-tighter">INVOICE</h2>
                    <p class="text-xl font-bold text-teal-700 mt-1">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</p>
                    <p class="text-slate-500 mt-2 font-mono text-sm" dir="ltr" id="print-date">---</p>
                </div>
            </div>

            <!-- Ù…Ø´Ø®ØµØ§Øª Ø®Ø±ÛŒØ¯Ø§Ø±/Ù…Ø­ØµÙˆÙ„ -->
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <span class="text-slate-400 text-xs uppercase font-bold tracking-wider block mb-1">Ø´Ø±Ø­ Ù…Ø­ØµÙˆÙ„</span>
                        <span class="text-xl font-bold text-slate-800 leading-relaxed" id="print-title">---</span>
                    </div>
                    <div class="text-left">
                        <span class="text-slate-400 text-xs uppercase font-bold tracking-wider block mb-1">Ø´Ù†Ø§Ø³Ù‡ Ø³Ù†Ø¯</span>
                        <span class="text-sm font-mono text-slate-600 bg-white px-2 py-1 rounded border" id="print-id">---</span>
                    </div>
                </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ù„Ø§Ù… -->
            <table class="w-full mb-8 border-collapse">
                <thead>
                    <tr class="bg-slate-800 text-white text-sm">
                        <th class="text-right p-4 rounded-r-xl w-1/2">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Ø§Øª</th>
                        <th class="text-center p-4 w-24">ØªØ¹Ø¯Ø§Ø¯</th>
                        <th class="text-center p-4 w-24 rounded-l-xl">ÙˆØ§Ø­Ø¯</th>
                    </tr>
                </thead>
                <tbody id="print-rows" class="text-sm font-medium text-slate-700">
                    <!-- Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ -->
                </tbody>
            </table>

            <!-- Ø¬Ù…Ø¹ Ú©Ù„ -->
            <div class="flex justify-end mt-auto">
                <div class="w-full md:w-1/2 space-y-2">
                    <!-- Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§ØªÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù‡ -->
                    <div class="flex justify-between text-slate-500 pb-2">
                        <span>Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ (Ù…ÙˆØ§Ø¯ + Ø³Ø±Ø¨Ø§Ø±):</span>
                        <span class="font-mono font-bold text-slate-800" id="print-base">0</span>
                    </div>
                    <div class="flex justify-between text-teal-600 pb-2">
                        <span>Ø³ÙˆØ¯ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡:</span>
                        <span class="font-mono font-bold" id="print-profit">0</span>
                    </div>
                    <div class="flex justify-between text-slate-700 border-t border-slate-200 pt-2">
                        <span class="font-bold">Ø¬Ù…Ø¹ Ú©Ù„ (Ø¨Ø¯ÙˆÙ† Ù…Ø§Ù„ÛŒØ§Øª):</span>
                        <span class="font-mono font-bold" id="print-subtotal">0</span>
                    </div>
                    <div class="flex justify-between text-amber-600 pb-2">
                        <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (Û±Û°Ùª):</span>
                        <span class="font-mono font-bold" id="print-vat">0</span>
                    </div>
                    
                    <div class="bg-slate-100 p-4 rounded-xl flex justify-between items-center mt-4 border border-slate-200">
                        <span class="text-lg font-bold text-slate-900">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <div class="text-right">
                            <span class="text-2xl font-black text-teal-700 block" id="print-final">0</span>
                            <span class="text-xs text-slate-400">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÙÙˆØªØ± Ù¾Ø±ÛŒÙ†Øª (ÙÙ‚Ø· Ø¯Ø± ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´) -->
            <div class="mt-12 text-center no-print border-t border-slate-100 pt-6 flex justify-center gap-4">
                <button onclick="window.print()" class="btn btn-primary px-8 text-lg shadow-xl">Ú†Ø§Ù¾ / Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
                <button onclick="closeModal('print-modal')" class="btn btn-secondary px-6">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª APPWRITE
        // ==========================================
        const APPWRITE_CONFIG = {
            ENDPOINT: 'https://cloud.appwrite.io/v1',
            PROJECT_ID: '691c9337000c1532f26a',  // <--- Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
            DB_ID: '691c956400150133e319',      // <--- Ø´Ù†Ø§Ø³Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
            COLS: {
                CATS: 'categories',
                MATS: 'materials',
                FORMS: 'formulas'
            }
        };

        // --- Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Appwrite ---
        if (typeof Appwrite === 'undefined') {
            document.getElementById('loading-text').innerText = "Ø®Ø·Ø§: Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Appwrite Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ VPN Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
            document.getElementById('loading-text').classList.add('text-red-400');
            document.getElementById('loader-spinner').style.display = 'none';
        }

        const { Client, Account, Databases, ID, Query, Permission, Role } = Appwrite;
        const client = new Client().setEndpoint(APPWRITE_CONFIG.ENDPOINT).setProject(APPWRITE_CONFIG.PROJECT_ID);
        const account = new Account(client);
        const db = new Databases(client);

        let state = { categories: [], materials: [], formulas: [], activeFormulaId: null, publicFormulas: [] };

        // ==========================================
        // 2. Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù†Ø§Ø´Ù†Ø§Ø³)
        // ==========================================
        async function init() {
            // Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±
            if (APPWRITE_CONFIG.PROJECT_ID === 'YOUR_PROJECT_ID' || APPWRITE_CONFIG.DB_ID === 'YOUR_DATABASE_ID') {
                 document.getElementById('loading-text').innerHTML = `<span class="text-amber-400 text-lg">âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!</span><br>Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§ Notepad Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Appwrite Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ APPWRITE_CONFIG ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.`;
                 document.getElementById('loader-spinner').style.display = 'none';
                 return;
            }

            try {
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø³Ø´Ù† Ù‚Ø¨Ù„ÛŒ
                try { await account.get(); } 
                catch { 
                    // Ø§Ú¯Ø± Ø³Ø´Ù† Ù†Ø¨ÙˆØ¯ØŒ ÛŒÚ© Ø³Ø´Ù† Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ø³Ø§Ø²
                    console.log("Creating anonymous session...");
                    await account.createAnonymousSession(); 
                }
                
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                await loadAllData();
                
                // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                let msg = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„! Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Appwrite Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ Ú©Ø¯ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
                if (err.message.includes('Network Error') || err.message.includes('Failed to fetch')) {
                    msg = "Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ø§Ø² Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø§Ù…Ù†Ù‡ Ø±Ø§ Ø¯Ø± Appwrite Platform Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.";
                }
                document.getElementById('loading-text').innerText = msg;
                document.getElementById('loading-text').classList.add('text-red-400', 'font-bold');
                document.getElementById('loader-spinner').style.display = 'none';
            }
        }

        // ==========================================
        // 3. Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        // ==========================================
        async function loadAllData() {
            document.getElementById('loading-text').innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§...';
            
            // Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ø²Ù…Ø§Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            const [cRes, mRes, fRes] = await Promise.all([
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, [Query.limit(100)]),
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, [Query.limit(5000)]),
                db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, [Query.limit(500)])
            ]);

            state.categories = cRes.documents;
            state.materials = mRes.documents;
            state.formulas = fRes.documents.sort((a, b) => new Date(b.$updatedAt) - new Date(a.$updatedAt));

            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Store)
            try {
                const storeRes = await db.listDocuments(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, [
                    Query.equal('is_public', true),
                    Query.limit(50)
                ]);
                state.publicFormulas = storeRes.documents;
            } catch (e) { 
                console.warn("Store query failed. Make sure you have an Index on 'is_public' in Appwrite.", e); 
            }
            
            updateUI();
        }

        function updateUI() {
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§
            const sortKey = document.getElementById('sort-materials')?.value || 'name_asc';
            sortMaterials(state.materials, sortKey);

            renderCategories();
            renderMaterials();
            renderFormulaList();
            updateDropdowns();
            renderStore();
            
            // Ø§Ú¯Ø± ÙØ±Ù…ÙˆÙ„ÛŒ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†
            if (state.activeFormulaId) renderFormulaDetail(state.activeFormulaId);
        }

        // ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        function formatDate(isoString) {
            if (!isoString) return '';
            return new Date(isoString).toLocaleString('fa-IR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // ÙØ±Ù…Øª Ù‚ÛŒÙ…Øª (Û³ Ø±Ù‚Ù… Û³ Ø±Ù‚Ù…)
        function formatPrice(num) {
            return Number(num).toLocaleString('en-US');
        }

        // ==========================================
        // 4. Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
        // ==========================================
        async function handleAddCategory(e) {
            e.preventDefault();
            const nameInput = document.getElementById('cat-name');
            const name = nameInput.value.trim();
            if (!name) return;
            
            try {
                await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, ID.unique(), { name });
                nameInput.value = '';
                await loadAllData();
            } catch (err) { alert(err.message); }
        }

        async function deleteCategory(id) {
            if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            try {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.CATS, id);
                await loadAllData();
            } catch (err) { alert(err.message); }
        }

        function renderCategories() {
            document.getElementById('category-list').innerHTML = state.categories.map(c => `
                <div class="flex justify-between bg-slate-100 p-3 rounded-lg mb-2 border border-slate-200 items-center">
                    <span class="font-bold text-slate-700">${c.name}</span>
                    <button onclick="deleteCategory('${c.$id}')" class="text-rose-500 hover:bg-rose-100 p-2 rounded-full transition-colors">ğŸ—‘</button>
                </div>
            `).join('');
        }

        // ==========================================
        // 5. Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡
        // ==========================================
        function sortMaterials(list, key) {
            list.sort((a, b) => {
                if (key === 'name_asc') return a.name.localeCompare(b.name);
                if (key === 'price_desc') return b.price - a.price;
                if (key === 'price_asc') return a.price - b.price;
                if (key === 'date_desc') return new Date(b.$updatedAt) - new Date(a.$updatedAt);
                return 0;
            });
        }

        async function handleSaveMaterial(e) {
            e.preventDefault();
            const id = document.getElementById('mat-id').value;
            const name = document.getElementById('mat-name').value.trim();
            const unit = document.getElementById('mat-unit').value;
            const price = parseFloat(document.getElementById('mat-price').value.replace(/,/g, ''));
            const category_id = document.getElementById('mat-category').value || null;

            const data = { name, unit, price, category_id };

            try {
                if (id) {
                    await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, id, data);
                } else {
                    await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, ID.unique(), data);
                }
                resetMaterialForm();
                await loadAllData();
            } catch (err) { alert('Ø®Ø·Ø§: ' + err.message); }
        }

        function renderMaterials(filter = '') {
            const container = document.getElementById('materials-container');
            const filtered = state.materials.filter(m => m.name.includes(filter));
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-slate-400 py-8">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            container.innerHTML = filtered.map(m => {
                const cat = state.categories.find(c => c.$id === m.category_id)?.name || 'Ø³Ø§ÛŒØ±';
                // ØªØ§Ø±ÛŒØ® Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ (Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø®ØªÙ„Ø§Ù Ø²Ù…Ø§Ù†ÛŒ)
                const diffDays = Math.floor((new Date() - new Date(m.$updatedAt)) / (1000 * 60 * 60 * 24));
                const isOld = diffDays > 30;
                
                return `
                <div class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-teal-400 transition-all group relative shadow-sm hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded border border-slate-200">${cat}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editMaterial('${m.$id}')" class="text-amber-500 hover:bg-amber-50 p-1 rounded">âœï¸</button>
                            <button onclick="deleteMaterial('${m.$id}')" class="text-rose-500 hover:bg-rose-50 p-1 rounded">ğŸ—‘</button>
                        </div>
                    </div>
                    <div class="mt-2 font-bold text-slate-800 text-lg">${m.name}</div>
                    <div class="mt-4 flex justify-between items-end border-t border-slate-100 pt-3">
                        <div class="flex flex-col items-start">
                            <span class="text-xs text-slate-400">${m.unit}</span>
                            <div class="update-badge mt-1 ${isOld ? 'old' : 'new'}">
                                <span>${formatDate(m.$updatedAt)}</span>
                            </div>
                        </div>
                        <div class="font-mono font-black text-teal-700 text-xl tracking-tight">${formatPrice(m.price)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function editMaterial(id) {
            const m = state.materials.find(x => x.$id === id);
            if(!m) return;
            document.getElementById('mat-id').value = m.$id;
            document.getElementById('mat-name').value = m.name;
            document.getElementById('mat-unit').value = m.unit;
            document.getElementById('mat-price').value = formatPrice(m.price);
            document.getElementById('mat-category').value = m.category_id || "";
            
            document.getElementById('mat-submit-btn').innerText = "Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù„Ø§";
            document.getElementById('mat-submit-btn').classList.add('bg-amber-500', 'hover:bg-amber-600', 'text-white');
            document.getElementById('mat-submit-btn').classList.remove('btn-primary');
            document.getElementById('mat-cancel-btn').classList.remove('hidden');
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteMaterial(id) {
            if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.MATS, id);
            await loadAllData();
        }

        function resetMaterialForm() {
            document.getElementById('material-form').reset();
            document.getElementById('mat-id').value = '';
            const btn = document.getElementById('mat-submit-btn');
            btn.innerText = "Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±";
            btn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            btn.classList.add('btn-primary');
            document.getElementById('mat-cancel-btn').classList.add('hidden');
        }

        function updateDropdowns() {
            const sel = document.getElementById('mat-category');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>' + 
                state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('');
            sel.value = currentVal;

            // Ø¢Ù¾Ø¯ÛŒØª ÙÛŒÙ„ØªØ± Ø¯Ø± ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§
            const activeId = state.activeFormulaId;
            if(activeId) {
                const filterSel = document.getElementById(`comp-filter-${activeId}`);
                if(filterSel) {
                     filterSel.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>' + 
                        state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('') + 
                        '<option value="formulas">ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡</option>';
                }
                updateComponentSelect(activeId);
            }
        }

        // ==========================================
        // 6. ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (Formulas)
        // ==========================================
        async function handleCreateFormula() {
            const name = document.getElementById('new-formula-name').value.trim();
            if(!name) return;
            try {
                const res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, ID.unique(), {
                    name, 
                    components_json: '[]', 
                    labor: 0.0, overhead: 0.0, profit: 0.0,
                    is_public: false
                });
                state.formulas.unshift(res);
                document.getElementById('new-formula-name').value = '';
                document.getElementById('new-formula-modal').classList.remove('flex');
                document.getElementById('new-formula-modal').classList.add('hidden');
                selectFormula(res.$id);
            } catch(err) { console.error(err); }
        }

        function renderFormulaList(filter = '') {
            const list = state.formulas.filter(f => f.name.includes(filter));
            document.getElementById('formula-master-list').innerHTML = list.map(f => `
                <div onclick="selectFormula('${f.$id}')" class="p-4 border-b border-slate-100 cursor-pointer hover:bg-teal-50 transition-all flex justify-between items-center group ${f.$id === state.activeFormulaId ? 'bg-teal-50 border-r-4 border-teal-600' : ''}">
                    <div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-teal-700">${f.name}</div>
                        <div class="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                            <span>ğŸ•’ ${formatDate(f.$updatedAt)}</span>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteFormula('${f.$id}')" class="text-slate-300 hover:text-rose-500 p-2 rounded-full hover:bg-rose-50 opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
                </div>
            `).join('');
        }

        function selectFormula(id) {
            state.activeFormulaId = id;
            renderFormulaList(); // Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ú©ØªÛŒÙˆ
            document.getElementById('formula-detail-empty').classList.add('hidden');
            document.getElementById('formula-detail-view').classList.remove('hidden');
            renderFormulaDetail(id);
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ Ù‚ÛŒÙ…Øª
        function calculateCost(f) {
            let matCost = 0;
            const comps = JSON.parse(f.components_json || '[]');
            comps.forEach(c => {
                if(c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if(m) matCost += m.price * c.qty;
                } else if (c.type === 'form') {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    if(sub) matCost += calculateCost(sub).final * c.qty; // Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ
                }
            });
            const sub = matCost + (f.labor || 0) + (f.overhead || 0);
            const profit = (f.profit || 0) / 100 * sub;
            return { matCost, sub, profit, final: sub + profit };
        }

        function renderFormulaDetail(id) {
            const f = state.formulas.find(x => x.$id === id);
            if(!f) return;
            const calc = calculateCost(f);
            const comps = JSON.parse(f.components_json || '[]');

            // Ø³Ø§Ø®Øª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„
            const rows = comps.map((c, idx) => {
                let name='?', unit='-', price=0, total=0;
                if(c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if(m) { name=m.name; unit=m.unit; price=m.price; total=price*c.qty; }
                    else name=`<span class="text-red-500">Ú©Ø§Ù„Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡ (${c.id})</span>`;
                } else {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    if(sub) { name=`<span class="text-purple-600 font-bold">ğŸ”— ${sub.name}</span>`; unit='Ø¹Ø¯Ø¯'; price=calculateCost(sub).final; total=price*c.qty; }
                }
                return `
                <div class="flex justify-between items-center p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 group transition-colors">
                    <div class="flex-grow">
                        <div class="font-bold text-slate-700 text-sm">${name}</div>
                        <div class="text-xs text-slate-400 mt-1"><span class="font-mono text-slate-600 bg-slate-100 px-1 rounded">${c.qty}</span> ${unit} Ã— <span class="font-mono">${formatPrice(price)}</span></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-mono font-bold text-slate-600 text-sm">${formatPrice(total)}</span>
                        <button onclick="removeComp('${id}', ${idx})" class="text-rose-300 hover:text-rose-600 p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">ğŸ—‘</button>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('formula-detail-view').innerHTML = `
                <div class="card !mb-0 border-t-0 !shadow-none">
                    <!-- Ù‡Ø¯Ø± ÙØ±Ù…ÙˆÙ„ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… -->
                    <div class="flex justify-between items-start mb-6 pb-4 border-b border-slate-100">
                        <div class="w-full">
                            <div class="flex items-center gap-2 group mb-2">
                                <h2 class="text-2xl font-black text-slate-800 cursor-text hover:bg-slate-50 px-2 rounded -ml-2 border border-transparent hover:border-slate-200 transition-all" onclick="editFormulaName('${id}')" title="Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯">${f.name}</h2>
                                <span class="text-slate-300 text-sm group-hover:text-teal-500">âœ</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded">Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: ${formatDate(f.$updatedAt)}</span>
                                <span class="text-[10px] bg-teal-50 text-teal-600 px-2 py-1 rounded border border-teal-100">ID: ${f.$id}</span>
                            </div>
                        </div>
                        <button onclick="deleteFormula('${id}')" class="btn btn-danger px-3 py-2 text-xs">Ø­Ø°Ù Ú©Ù„ Ù…Ø­ØµÙˆÙ„</button>
                    </div>
                    
                    <!-- Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø²Ø¡ -->
                    <form onsubmit="addComp(event, '${id}')" class="bg-slate-50 p-4 rounded-2xl mb-6 flex flex-col md:flex-row gap-3 border border-slate-200">
                        <div class="w-full md:w-40">
                            <select id="comp-filter-${id}" onchange="updateComponentSelect('${id}')" class="input-field text-xs h-full">
                                <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
                                ${state.categories.map(c => `<option value="${c.$id}">${c.name}</option>`).join('')}
                                <option value="formulas">Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯ÛŒÚ¯Ø±</option>
                            </select>
                        </div>
                        <div class="flex-grow">
                            <select id="comp-select-${id}" class="input-field h-full text-sm" required></select>
                        </div>
                        <div class="w-24">
                            <input type="number" id="comp-qty-${id}" step="any" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="input-field h-full text-center font-bold" required>
                        </div>
                        <button class="btn btn-primary px-6 text-xl leading-none rounded-xl shadow-none">+</button>
                    </form>

                    <!-- Ù„ÛŒØ³Øª Ø§Ø¬Ø²Ø§ -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden mb-6 max-h-64 overflow-y-auto custom-scrollbar bg-white">
                        ${rows || '<p class="text-center text-slate-400 p-8 text-sm flex flex-col items-center gap-2"><span class="text-3xl opacity-50">ğŸ“¦</span>Ù‡Ù†ÙˆØ² Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>'}
                    </div>

                    <!-- Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ -->
                    <div class="grid grid-cols-3 gap-4 mb-6 bg-slate-50 p-5 rounded-2xl border border-slate-200">
                        <div>
                            <label class="text-xs text-slate-500 font-bold block mb-2">Ø¯Ø³ØªÙ…Ø²Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                            <input class="input-field text-sm h-10 font-mono font-bold text-slate-700" value="${formatPrice(f.labor)}" onchange="updateCost('${id}','labor',this.value)">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 font-bold block mb-2">Ø³Ø±Ø¨Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
                            <input class="input-field text-sm h-10 font-mono font-bold text-slate-700" value="${formatPrice(f.overhead)}" onchange="updateCost('${id}','overhead',this.value)">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 font-bold block mb-2">Ø³ÙˆØ¯ (%)</label>
                            <input type="number" class="input-field text-sm h-10 font-mono font-bold text-slate-700" value="${f.profit}" onchange="updateCost('${id}','profit',this.value)">
                        </div>
                    </div>

                    <!-- Ú©Ø§Ø±Øª Ù†Ù‡Ø§ÛŒÛŒ Ù‚ÛŒÙ…Øª -->
                    <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 via-cyan-400 to-blue-500"></div>
                        
                        <div class="flex justify-between text-sm text-slate-400 mb-2">
                            <span>Ø¬Ù…Ø¹ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡:</span> 
                            <span class="font-mono text-slate-200">${formatPrice(calc.matCost)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-400 pb-4 border-b border-slate-700 mb-4">
                            <span>Ù‡Ø²ÛŒÙ†Ù‡ ØªÙˆÙ„ÛŒØ¯ (Ù…ÙˆØ§Ø¯ + Ø¯Ø³ØªÙ…Ø²Ø¯ + Ø³Ø±Ø¨Ø§Ø±):</span> 
                            <span class="font-mono text-slate-200">${formatPrice(calc.sub)}</span>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center py-2">
                            <span class="text-slate-400 text-xs uppercase tracking-widest mb-1">Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ ÙØ±ÙˆØ´ (Ø¨Ø¯ÙˆÙ† Ù…Ø§Ù„ÛŒØ§Øª)</span>
                            <span class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400 font-mono tracking-tight">${formatPrice(calc.final)}</span>
                            <span class="text-sm text-teal-400 mt-1">ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        
                        <button onclick="printFormula('${id}')" class="w-full mt-6 btn bg-white/10 hover:bg-white/20 border border-white/10 text-white text-sm backdrop-blur-sm">
                            ğŸ–¨ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ú†Ø§Ù¾ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±
                        </button>
                    </div>
                </div>
            `;
            
            updateComponentSelect(id);
        }

        // --- FORMULA ACTIONS ---
        function updateComponentSelect(id) {
            const filter = document.getElementById(`comp-filter-${id}`).value;
            const select = document.getElementById(`comp-select-${id}`);
            let options = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';

            if(filter === 'formulas') {
                const others = state.formulas.filter(f => f.$id !== id);
                if(others.length) {
                    options += `<optgroup label="Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯ÛŒÚ¯Ø±">` + 
                        others.map(f => `<option value="FORM:${f.$id}">ğŸ”— ${f.name}</option>`).join('') + 
                        `</optgroup>`;
                }
            } else {
                const mats = state.materials.filter(m => filter === '' || m.category_id === filter);
                // Ú¯Ø±ÙˆÙ‡ Ø¨Ù†Ø¯ÛŒ Ù…ÙˆØ§Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ "Ù‡Ù…Ù‡"
                state.categories.forEach(cat => {
                     if(filter !== '' && filter !== cat.$id) return;
                     const catMats = mats.filter(m => m.category_id === cat.$id);
                     if(catMats.length) {
                         options += `<optgroup label="${cat.name}">` + 
                             catMats.map(m => `<option value="MAT:${m.$id}">${m.name}</option>`).join('') + 
                             `</optgroup>`;
                     }
                });
                // Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡
                const noCat = mats.filter(m => !m.category_id);
                if(noCat.length && (filter === '' || filter === 'null')) {
                    options += `<optgroup label="Ø³Ø§ÛŒØ±">` + noCat.map(m => `<option value="MAT:${m.$id}">${m.name}</option>`).join('') + `</optgroup>`;
                }
            }
            select.innerHTML = options;
        }

        async function addComp(e, fid) {
            e.preventDefault();
            const val = document.getElementById(`comp-select-${fid}`).value;
            const qty = parseFloat(document.getElementById(`comp-qty-${fid}`).value);
            if(!val) return;

            const [prefix, id] = val.split(':');
            const type = prefix === 'MAT' ? 'mat' : 'form';

            const f = state.formulas.find(x => x.$id === fid);
            const comps = JSON.parse(f.components_json || '[]');
            
            const exist = comps.find(c => c.id === id && c.type === type);
            if(exist) exist.qty += qty; else comps.push({id, type, qty});

            try {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { components: JSON.stringify(comps) });
                await loadAllData();
                renderFormulaDetail(fid);
            } catch(err) { console.error(err); }
        }

        async function removeComp(fid, idx) {
            const f = state.formulas.find(x => x.$id === fid);
            const comps = JSON.parse(f.components_json || '[]');
            comps.splice(idx, 1);
            await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { components_json: JSON.stringify(comps) });
            await loadAllData();
            renderFormulaDetail(fid);
        }

        async function updateCost(fid, field, val) {
            const num = parseFloat(val.replace(/,/g, '')) || 0;
            await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, fid, { [field]: num });
            await loadAllData();
            renderFormulaDetail(fid);
        }

        async function editFormulaName(id) {
            const f = state.formulas.find(x => x.$id === id);
            const newName = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù…Ø­ØµÙˆÙ„:");
            if(newName) {
                await db.updateDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, id, { name: newName });
                await loadAllData();
                renderFormulaDetail(id);
            }
        }

        async function deleteFormula(id) {
            if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                await db.deleteDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, id);
                state.activeFormulaId = null;
                document.getElementById('formula-detail-view').classList.add('hidden');
                document.getElementById('formula-detail-empty').classList.remove('hidden');
                await loadAllData();
            }
        }

        // ==========================================
        // 7. BANK / STORE (ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡)
        // ==========================================
        function renderStore() {
            const list = document.getElementById('store-container');
            if(state.publicFormulas.length === 0) {
                list.innerHTML = `<div class="col-span-full text-center p-12 bg-white rounded-2xl border-2 border-dashed border-purple-200 text-purple-400">
                    <span class="text-4xl block mb-2">ğŸ’</span>
                    Ù‡Ù†ÙˆØ² Ù‚Ø§Ù„Ø¨ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.
                </div>`;
                return;
            }

            list.innerHTML = state.publicFormulas.map(f => `
                <div class="bg-white p-6 rounded-2xl border border-purple-100 shadow-sm hover:shadow-xl transition-all relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-purple-600 text-white text-[10px] px-3 py-1 rounded-bl-xl font-bold shadow-md">PREMIUM</div>
                    <h3 class="font-bold text-xl text-slate-800 mt-2 mb-2">${f.name}</h3>
                    <p class="text-xs text-slate-500 mb-6 leading-relaxed">Ù‚Ø§Ù„Ø¨ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆÙ„ÛŒØ¯. Ø´Ø§Ù…Ù„ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù…ÙˆØ§Ø¯ Ùˆ Ø¶Ø±Ø§ÛŒØ¨ Ù…ØµØ±Ù.</p>
                    <button onclick="copyTemplate('${f.$id}')" class="w-full py-3 rounded-xl font-bold bg-purple-50 text-purple-700 border border-purple-200 hover:bg-purple-600 hover:text-white transition-colors flex justify-center items-center gap-2">
                        <span>ğŸ“¥</span> Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ù†
                    </button>
                </div>
            `).join('');
        }

        async function copyTemplate(id) {
            if(!confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ØŸ")) return;
            const template = state.publicFormulas.find(f => f.$id === id);
            if(!template) return;

            try {
                const res = await db.createDocument(APPWRITE_CONFIG.DB_ID, APPWRITE_CONFIG.COLS.FORMS, ID.unique(), {
                    name: template.name + ' (Ú©Ù¾ÛŒ)',
                    components_json: template.components_json,
                    labor: template.labor, overhead: template.overhead, profit: template.profit,
                    is_public: false
                });
                // Ú©Ù¾ÛŒ Ù…ÙˆÙÙ‚
                switchTab('formulas');
                await loadAllData();
                selectFormula(res.$id);
                alert('Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…');
            } catch(e) { alert(e.message); }
        }

        // ==========================================
        // 8. PRINT
        // ==========================================
        function printFormula(id) {
            const f = state.formulas.find(x => x.$id === id);
            const calc = calculateCost(f);
            const comps = JSON.parse(f.components_json || '[]');

            document.getElementById('print-title').innerText = f.name;
            document.getElementById('print-id').innerText = f.$id.substring(0, 8).toUpperCase();
            document.getElementById('print-date').innerText = new Date().toLocaleDateString('fa-IR');

            let rows = '';
            comps.forEach(c => {
                let name, unit, q = c.qty;
                if(c.type === 'mat') {
                    const m = state.materials.find(x => x.$id === c.id);
                    if(m) { name=m.name; unit=m.unit; }
                } else {
                    const sub = state.formulas.find(x => x.$id === c.id);
                    if(sub) { name=`${sub.name} (Ù¾ÛŒØ´â€ŒØ³Ø§Ø®ØªÙ‡)`; unit='Ø¹Ø¯Ø¯'; }
                }
                if(name) rows += `
                    <tr class="border-b border-slate-200 last:border-0">
                        <td class="p-4 text-right">${name}</td>
                        <td class="p-4 text-center font-mono">${q}</td>
                        <td class="p-4 text-center text-slate-500">${unit}</td>
                    </tr>`;
            });
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡
            const basePrice = calc.matCost + (calc.sub - calc.matCost); // Ù…ÙˆØ§Ø¯ + Ø³Ø±Ø¨Ø§Ø± + Ø¯Ø³ØªÙ…Ø²Ø¯
            const profit = calc.profit;
            const subTotal = calc.final; // Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª
            const vat = Math.round(subTotal * 0.10); // Û±Û° Ø¯Ø±ØµØ¯ Ù…Ø§Ù„ÛŒØ§Øª
            const finalTotal = subTotal + vat;

            document.getElementById('print-rows').innerHTML = rows;
            
            document.getElementById('print-base').innerText = formatPrice(basePrice);
            document.getElementById('print-profit').innerText = formatPrice(profit);
            document.getElementById('print-subtotal').innerText = formatPrice(subTotal);
            document.getElementById('print-vat').innerText = formatPrice(vat);
            document.getElementById('print-final').innerText = formatPrice(finalTotal);

            document.getElementById('print-modal').classList.remove('hidden');
            document.getElementById('print-modal').classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        // ==========================================
        // 9. UTILS
        // ==========================================
        function switchTab(tab) {
            ['formulas', 'materials', 'categories', 'store'].forEach(t => {
                const el = document.getElementById('tab-'+t);
                const btn = document.getElementById('btn-'+t);
                if(el) el.classList.add('hidden');
                if(btn) btn.classList.remove('active'); // Store tab doesn't have nav btn sometimes
            });
            document.getElementById('tab-'+tab).classList.remove('hidden');
            const activeBtn = document.getElementById('btn-'+tab);
            if(activeBtn) activeBtn.classList.add('active');
        }

        function formatInput(el) {
            const v = el.value.replace(/[^0-9.]/g, '');
            if(v) el.value = parseFloat(v).toLocaleString();
        }

        // Start
        init();
    </script>
</body>
</html>
